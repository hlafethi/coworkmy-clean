import{r as o,k as v,s as c,u as m,l as g,j as x}from"./index-DjQDvwSR.js";import"./client-DHZYSnFT.js";const A=()=>{const[l,i]=o.useState(null),[y,u]=o.useState(!0),[p,f]=o.useState(!1),[I,s]=o.useState(!1),k=v(),E=o.useRef(!1),t=o.useRef(!0),d=o.useRef(0);o.useEffect(()=>{t.current=!0;const n=async()=>{if(!E.current){E.current=!0;try{const{data:{user:e},error:r}=await c.auth.getUser();if(r){r.message.includes("Auth session missing")||(r.message.includes("Invalid JWT")||r.message.includes("JWT expired")?(localStorage.removeItem("sb-auth-token"),localStorage.removeItem("coworkmy-auth-token"),await c.auth.signOut()):g.error("[useAuth] Error getting initial user:",r)),t.current&&(i(null),f(!1),s(!0),u(!1));return}e&&t.current?(i(e),await S(e)):t.current&&(i(null),f(!1),s(!0)),t.current&&u(!1)}catch(e){g.error("[useAuth] Error during initialization:",e),t.current&&(i(null),f(!1),s(!0),u(!1))}}},{data:{subscription:a}}=c.auth.onAuthStateChange(async(e,r)=>{t.current&&(e==="SIGNED_IN"&&(r!=null&&r.user)?(i(r.user),s(!1),d.current=0,await S(r.user)):e==="SIGNED_OUT"?(i(null),f(!1),s(!0),d.current=0,localStorage.removeItem("sb-auth-token"),localStorage.removeItem("coworkmy-auth-token")):e==="USER_UPDATED"&&(r!=null&&r.user)&&(i(r.user),s(!1),await S(r.user)),t.current&&u(!1))});return n(),()=>{t.current=!1,a.unsubscribe()}},[]);const S=async n=>{try{let{data:a,error:e}=await c.from("profiles").select("is_admin, id, user_id, email").eq("user_id",n.id).single();if(e&&e.code==="PGRST116"){const{data:w,error:h}=await c.from("profiles").select("is_admin, id, user_id, email").eq("id",n.id).single();h?e=h:(a=w,e=null)}if(e&&e.code==="PGRST116"){const{data:w,error:h}=await c.from("profiles").select("is_admin, id, user_id, email").eq("email",n.email).single();h?e=h:(a=w,e=null)}if(e&&e.code!=="PGRST116")throw e;const r=(a==null?void 0:a.is_admin)||!1;r&&!n.email_confirmed_at&&m.warning("Votre email n'est pas confirmé. Certaines fonctionnalités admin peuvent être limitées."),t.current&&(f(r),s(!0),d.current=0)}catch(a){if(g.error("[useAuth] Error fetching profile:",a),a&&typeof a=="object"&&"message"in a){const e=a.message;if(e.includes("JWT expired")||e.includes("Invalid JWT")){m.error("Session expirée, veuillez vous reconnecter"),await b();return}}if(d.current<3){d.current++,g.log(`[useAuth] Retry ${d.current}/3 - Profile fetch failed`),setTimeout(()=>{t.current&&l&&S(l)},1e3*d.current);return}t.current&&(f(!1),s(!0))}},b=async()=>{try{const{error:n}=await c.auth.signOut();if(n)throw n;t.current&&(i(null),f(!1),s(!0)),localStorage.removeItem("sb-auth-token"),localStorage.removeItem("coworkmy-auth-token"),k("/auth/login")}catch(n){g.error("Erreur lors de la déconnexion:",n),m.error("Erreur lors de la déconnexion")}};return{user:l,loading:y||!I,isAdmin:p,signOut:b}};function R(){const l=v(),{checkSession:i}=A();return o.useEffect(()=>{(async()=>{try{const{data:{session:u},error:p}=await c.auth.getSession();if(p)throw p;u?(await i(),m.success("Connexion réussie"),l("/dashboard")):(m.error("Session non trouvée"),l("/auth/login"))}catch(u){console.error("Erreur lors de la connexion:",u),m.error("Erreur lors de la connexion"),l("/auth/login")}})()},[l,i]),x.jsx("div",{className:"flex items-center justify-center min-h-screen",children:x.jsxs("div",{className:"text-center",children:[x.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Connexion en cours..."}),x.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"})]})})}export{R as default};
