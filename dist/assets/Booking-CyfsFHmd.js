import{r as u,g as w,j as e,C as T,b as j,a as I,e as M,m as K,ar as Q,k as W,i as X,l as Z,B as z,A as q,u as h}from"./index-t_7sXq-_.js";import{C as H,u as ee,B as re}from"./useStripePayment-ECseeHcl.js";import{R as te,a as ie}from"./use-toast-CBKXrERS.js";import{T as ae,a as se,b as le,c as ne}from"./tooltip-D1YFZ819.js";import{A as V,b as B,a as P}from"./alert-CbSMjElM.js";import{u as ce}from"./stripeUtils-D6xlIHGD.js";function oe(o){const[r,_]=u.useState(null),[l,d]=u.useState([]),[m,t]=u.useState(null),[v,b]=u.useState(!1);return u.useEffect(()=>{if(!o)return;b(!0),(async()=>{try{const n=await w.get(`/spaces/${o}`);n.success&&_(n.data)}catch(n){console.error("Erreur lors du chargement de l'espace:",n)}finally{b(!1)}})()},[o]),u.useEffect(()=>{if(!r)return;let a=[],n=r.pricing_type;switch(n||(r.hourly_price?n="hourly":r.daily_price?n="daily":r.half_day_price?n="half_day":r.monthly_price?n="monthly":r.quarter_price?n="quarter":r.yearly_price?n="yearly":r.custom_price&&(n="custom")),n){case"hourly":a=[{id:"1",label:"09:00 - 10:00",startTime:"09:00",endTime:"10:00",price:r.hourly_price*1.2,isAvailable:!0},{id:"2",label:"10:00 - 11:00",startTime:"10:00",endTime:"11:00",price:r.hourly_price*1.2,isAvailable:!0},{id:"3",label:"11:00 - 12:00",startTime:"11:00",endTime:"12:00",price:r.hourly_price*1.2,isAvailable:!0},{id:"4",label:"14:00 - 15:00",startTime:"14:00",endTime:"15:00",price:r.hourly_price*1.2,isAvailable:!0},{id:"5",label:"15:00 - 16:00",startTime:"15:00",endTime:"16:00",price:r.hourly_price*1.2,isAvailable:!0},{id:"6",label:"16:00 - 17:00",startTime:"16:00",endTime:"17:00",price:r.hourly_price*1.2,isAvailable:!0}];break;case"half_day":a=[{id:"morning",label:"Matin (9h-13h)",startTime:"09:00",endTime:"13:00",price:r.half_day_price*1.2,isAvailable:!0},{id:"afternoon",label:"Apr√®s-midi (14h-18h)",startTime:"14:00",endTime:"18:00",price:r.half_day_price*1.2,isAvailable:!0}];break;case"daily":a=[{id:"full-day",label:"Journ√©e compl√®te (9h-18h)",startTime:"09:00",endTime:"18:00",price:r.daily_price*1.2,isAvailable:!0}];break;case"monthly":a=[{id:"monthly",label:"Mois complet",startTime:"00:00",endTime:"23:59",price:r.monthly_price*1.2,isAvailable:!0}];break;case"quarter":a=[{id:"quarter",label:"Trimestre",startTime:"00:00",endTime:"23:59",price:r.quarter_price*1.2,isAvailable:!0}];break;case"yearly":a=[{id:"yearly",label:"Ann√©e",startTime:"00:00",endTime:"23:59",price:r.yearly_price*1.2,isAvailable:!0}];break;case"custom":a=[{id:"custom",label:r.custom_label||"P√©riode personnalis√©e",startTime:"00:00",endTime:"23:59",price:r.custom_price,isAvailable:!0}];break;default:r.price_per_hour?a=[{id:"1",label:"09:00 - 10:00",startTime:"09:00",endTime:"10:00",price:r.price_per_hour,isAvailable:!0},{id:"2",label:"10:00 - 11:00",startTime:"10:00",endTime:"11:00",price:r.price_per_hour,isAvailable:!0},{id:"3",label:"11:00 - 12:00",startTime:"11:00",endTime:"12:00",price:r.price_per_hour,isAvailable:!0},{id:"4",label:"14:00 - 15:00",startTime:"14:00",endTime:"15:00",price:r.price_per_hour,isAvailable:!0},{id:"5",label:"15:00 - 16:00",startTime:"15:00",endTime:"16:00",price:r.price_per_hour,isAvailable:!0},{id:"6",label:"16:00 - 17:00",startTime:"16:00",endTime:"17:00",price:r.price_per_hour,isAvailable:!0}]:a=[];break}d(a)},[r]),{space:r,timeSlots:l,selectedSlot:m,setSelectedSlot:t,loading:v}}function de({selectedDays:o,onDaysChange:r}){return e.jsx(T,{children:e.jsxs(j,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"S√©lectionnez vos dates"}),e.jsx(H,{mode:"multiple",selected:o,onSelect:_=>_&&r(_),className:"rounded-md border"})]})})}function ue({timeSlots:o,selectedSlot:r,onSlotSelect:_,space:l}){return o.length===0?e.jsxs(T,{className:"mt-6",children:[e.jsx(I,{children:e.jsx(M,{children:"Cr√©neaux horaires"})}),e.jsxs(j,{children:[e.jsxs(V,{variant:"warning",className:"mt-4",children:[e.jsx(B,{children:"Aucun cr√©neau disponible"}),e.jsx(P,{children:(l==null?void 0:l.pricing_type)==="monthly"?`Tarif mensuel non configur√© (actuel : ${l==null?void 0:l.monthly_price}‚Ç¨)`:"Contactez l'administrateur"})]}),e.jsx("div",{className:"mt-2 text-red-600 text-sm",children:"‚ö†Ô∏è V√©rifiez que le champ de prix correspondant (ex: daily_price, half_day_price, etc.) est bien renseign√© dans Supabase pour cet espace."})]})]}):e.jsxs(T,{className:"mt-6",children:[e.jsx(I,{children:e.jsx(M,{children:"Cr√©neaux horaires"})}),e.jsx(j,{children:e.jsx(te,{value:(r==null?void 0:r.id)||"",onValueChange:d=>{const m=o.find(t=>t.id===d);m&&_(m)},className:"space-y-4",children:o.map(d=>{const m=d.price??0,t=Math.round(m/1.2*100)/100;return e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ie,{value:d.id,id:d.id}),e.jsx(K,{htmlFor:d.id,className:"flex-1",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:d.label}),e.jsxs("span",{className:"flex flex-col items-end",children:[e.jsxs("span",{children:[t," ‚Ç¨ HT"]}),e.jsx(ae,{children:e.jsxs(se,{children:[e.jsx(le,{asChild:!0,children:e.jsxs("span",{className:"text-primary font-medium cursor-pointer underline decoration-dotted",children:[m," ‚Ç¨ TTC"]})}),e.jsx(ne,{children:e.jsx("span",{children:"TVA 20% incluse"})})]})})]})]})})]}),d.priceMissing&&e.jsx("div",{className:"text-red-600 text-xs ml-8",children:"‚ö†Ô∏è Prix manquant ou √† 0 pour ce type d'espace. Corrige le champ dans Supabase."})]},d.id)})})})]})}function be(){const{spaceId:o}=Q(),r=W(),_=X(),{user:l}=Z(),[d,m]=u.useState(null),{space:t,loading:v,timeSlots:b,selectedSlot:a,setSelectedSlot:n}=oe(o),[p,S]=u.useState([]),[A,L]=u.useState(null),[C,$]=u.useState(!1),{createPaymentSession:D}=ee();if(console.log("üìç Page Booking - spaceId:",o),console.log("üìç Location state:",_.state),u.useEffect(()=>{if(o)if(t){const c=new Date;S([c]),L({from:c,to:c})}else m("Impossible de charger les informations de l'espace. Veuillez r√©essayer.");else m("ID de l'espace manquant dans l'URL")},[o]),console.log("Loader state:",{loading:v}),v)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-lg",children:"Chargement..."})]})})});if(!t)return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(z,{variant:"outline",size:"sm",onClick:()=>r("/spaces"),className:"flex items-center gap-2 mb-6",children:[e.jsx(q,{className:"h-4 w-4"}),"Retour aux espaces"]}),e.jsxs(V,{variant:"destructive",children:[e.jsx(B,{children:"Une erreur est survenue"}),e.jsx(P,{children:d||"Une erreur inattendue s'est produite. Veuillez r√©essayer."})]})]});const O=c=>{n(c)},U=async()=>{if(!t||!a||p.length===0){h.error("Veuillez s√©lectionner un cr√©neau et une date");return}if(!C){h.error("Veuillez accepter les conditions g√©n√©rales");return}try{if(!l){h.error("Vous devez √™tre connect√© pour effectuer une r√©servation"),r("/auth/login");return}const c=new Date(p[0]);c.setHours(parseInt(a.startTime.split(":")[0])),c.setMinutes(parseInt(a.startTime.split(":")[1]));let i;t.pricing_type==="monthly"?(i=new Date(p[0]),i.setMonth(i.getMonth()+1),i.setDate(i.getDate()-1),i.setHours(23,59,59,999)):t.pricing_type==="quarter"?(i=new Date(p[0]),i.setMonth(i.getMonth()+3),i.setDate(i.getDate()-1),i.setHours(23,59,59,999)):t.pricing_type==="yearly"?(i=new Date(p[0]),i.setFullYear(i.getFullYear()+1),i.setDate(i.getDate()-1),i.setHours(23,59,59,999)):(i=new Date(p[0]),i.setHours(parseInt(a.endTime.split(":")[0])),i.setMinutes(parseInt(a.endTime.split(":")[1])));const E=await w.get(`/spaces/${t.id}/availability?start=${c.toISOString()}&end=${i.toISOString()}`);if(!E.success||!E.data.available){h.error("Cet espace est d√©j√† r√©serv√© pour cette p√©riode");return}const R=a.price||t.price_per_hour||0,G=R,Y=Math.round(R/1.2*100)/100,x={user_id:l.id,space_id:t.id,start_time:c.toISOString(),end_time:i.toISOString(),status:"pending",total_price_ht:Y,total_price_ttc:G,description:`R√©servation pour ${t.name}`,attendees:1},N=await w.post("/bookings",x);if(!N.success)throw new Error(N.error||"Erreur lors de la cr√©ation de la r√©servation");const f=N.data;if(console.log("‚úÖ R√©servation cr√©√©e avec succ√®s:",f),l==null?void 0:l.is_admin)try{const y=l.email||"admin@coworkmy.fr",{url:g,mode:J}=await D(f.id,Math.round(x.total_price_ttc*100),y,{booking_id:f.id,space_name:t.name,start_time:x.start_time,end_time:x.end_time});h.info("Redirection vers la page de paiement..."),window.location.href=g;return}catch(y){console.error("Erreur lors de la cr√©ation de la session de paiement:",y),h.error("Impossible de cr√©er la session de paiement. R√©servation cr√©√©e sans paiement."),r("/admin");return}else try{const y=l.email||"client@example.com",{url:g,mode:J}=await D(f.id,Math.round(x.total_price_ttc*100),y,{booking_id:f.id,space_name:t.name,start_time:x.start_time,end_time:x.end_time});h.info("Redirection vers la page de paiement..."),window.location.href=g;return}catch(y){console.error("Erreur lors de la cr√©ation de la session de paiement:",y),h.error("Impossible de cr√©er la session de paiement. Veuillez r√©essayer.");try{await ce(f.id,"cancelled")}catch(g){console.warn("Erreur lors de l'annulation de la r√©servation:",g)}return}}catch(c){h.error("Une erreur est survenue lors de la r√©servation ou du paiement."),console.error("Erreur lors de la cr√©ation de la r√©servation ou du paiement:",c)}},F=t,s=t,k=s?{id:s.id,name:s.name,description:s.description??"",capacity:s.capacity??0,image_url:s.image_url??"",is_available:s.is_available??!0,created_at:s.created_at??"",updated_at:s.updated_at??"",pricing_type:s.pricing_type??"hourly",hourly_price:s.hourly_price??0,daily_price:s.daily_price??0,monthly_price:s.monthly_price??0,yearly_price:s.yearly_price??0,half_day_price:s.half_day_price??0,quarter_price:s.quarter_price??0,custom_price:s.custom_price??0,custom_label:s.custom_label??"",price:s.price??0}:void 0;return console.log("üìç Espace actuel:",F),console.log("üìç Cr√©neaux disponibles:",b),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(z,{variant:"outline",size:"sm",onClick:()=>r("/spaces"),className:"flex items-center gap-2 mb-6",children:[e.jsx(q,{className:"h-4 w-4"}),"Retour aux espaces"]}),e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"R√©servation d'espace"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[t&&t.pricing_type!=="hourly"?e.jsx(T,{children:e.jsxs(j,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"S√©lectionnez votre date"}),e.jsx(H,{mode:"single",selected:p[0],onSelect:c=>S(c?[c]:[]),className:"rounded-md border"})]})}):e.jsx(de,{selectedDays:p,onDaysChange:S}),e.jsx(ue,{timeSlots:b,selectedSlot:a||void 0,onSlotSelect:O,space:t})]}),e.jsx("div",{children:k&&e.jsx(re,{space:k,selectedDays:p,selectedTimeSlot:a||void 0,isRecurring:!1,dateRange:A?{from:A.from||new Date,to:A.to||new Date}:void 0,termsAccepted:C,onTermsChange:$,onSubmit:U})})]})]})}export{be as default};
