import{r as i,an as K,j as t,m as Q,I as ve,i as pe,C as oe,b as le,f as ce,g as Se,d as ye,h as $,k as v,a as _e,ar as we,B as ee,A as fe}from"./index-DCtXYFOS.js";import{C as Ee,u as xe,B as Te}from"./useStripePayment-DITGO3eo.js";import{R as de,a as ae}from"./use-toast-B974eeY8.js";import"./client-7MFx3KKO.js";import{f as he,g as je,a as te,b as Z}from"./bookingUtils-yZhmP6yH.js";import{u as De}from"./index.esm-2ChYMtp7.js";import{a as Ce,o as Ae,s as re,n as ge,e as ke}from"./types-ayW2yWO7.js";import"./stripeUtils-CEzRnBBZ.js";const be=e=>({id:e.id,value:e.id,label:e.label,price:0,duration:e.duration,start_time:e.start_time,end_time:e.end_time,is_available:!0,space_id:"",display_order:e.display_order}),Ne=e=>({id:`custom-${e}`,value:`custom-${e}`,label:`${e} heure${e>1?"s":""}`,duration:e,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:0}),Oe=[{id:"1",label:"9h00 - 10h00",start_time:"09:00",end_time:"10:00",display_order:1,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"2",label:"10h00 - 11h00",start_time:"10:00",end_time:"11:00",display_order:2,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"3",label:"11h00 - 12h00",start_time:"11:00",end_time:"12:00",display_order:3,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"4",label:"14h00 - 15h00",start_time:"14:00",end_time:"15:00",display_order:4,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"5",label:"15h00 - 16h00",start_time:"15:00",end_time:"16:00",display_order:5,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"6",label:"16h00 - 17h00",start_time:"16:00",end_time:"17:00",display_order:6,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}],X=[{id:"morning",label:"Matin (9h-13h)",duration:4,price:0,start_time:"09:00",end_time:"13:00",is_available:!0,space_id:"",display_order:1},{id:"afternoon",label:"Après-midi (14h-18h)",duration:4,price:0,start_time:"14:00",end_time:"18:00",is_available:!0,space_id:"",display_order:2},{id:"full-day",label:"Journée complète (9h-18h)",duration:9,price:0,start_time:"09:00",end_time:"18:00",is_available:!0,space_id:"",display_order:3},{id:"monthly",label:"Mois complet",duration:720,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:4},{id:"quarter",label:"Trimestre",duration:2160,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:5},{id:"yearly",label:"Année",duration:8760,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:6}],Ie=e=>{const[u,y]=i.useState([]),[l,o]=i.useState(""),[_,r]=i.useState(0),[S,m]=i.useState(!0),[O,w]=i.useState(null);return i.useEffect(()=>{(async()=>{var s;try{m(!0),w(null);let a=[];if(!e||!["hourly","half_day","daily","monthly","quarter","yearly"].includes(e))throw new Error("Type de tarification invalide");switch(e){case"hourly":const{data:d}=await K.from("time_slots").select("*").order("display_order",{ascending:!0});a=d!=null&&d.length?d.map(be):Oe.map(be);break;case"half_day":a=X.filter(h=>h.id==="morning"||h.id==="afternoon");break;case"daily":a=X.filter(h=>h.id==="full-day");break;case"monthly":a=X.filter(h=>h.id==="monthly");break;case"quarter":a=X.filter(h=>h.id==="quarter");break;case"yearly":a=X.filter(h=>h.id==="yearly");break;default:a=[]}y(a),o(((s=a[0])==null?void 0:s.id)||"")}catch{w("Erreur inconnue"),y([]),o("")}finally{m(!1)}})()},[e]),{timeSlots:u,selectedSlot:l,setSelectedSlot:o,customHours:_,setCustomDuration:c=>{r(c);const s=Ne(c);y(a=>[...a.filter(h=>!String(h.id).startsWith("custom-")),s]),o(s.id)},loading:S,error:O,getCurrentSlotDuration:()=>{if(l.startsWith("custom-")){const s=parseInt(l.split("-")[1]);return isNaN(s)?0:s}const c=u.find(s=>s.id===l);return(c==null?void 0:c.duration)||0}}},Re=3,$e=1e3;async function se(e,u=Re,y=$e){try{return await e()}catch(l){if(u>0&&l instanceof Error&&(l.message.includes("ERR_INSUFFICIENT_RESOURCES")||l.message.includes("Failed to fetch")||l.message.includes("Invalid Refresh Token")||l.message.includes("JWT expired")))return console.warn(`Retrying operation after error: ${l.message}. Retries left: ${u}`),await new Promise(o=>setTimeout(o,y)),se(e,u-1,y*2);throw l}}function Fe(e){const[u,y]=i.useState(null),[l,o]=i.useState(!0),[_,r]=i.useState(null);i.useEffect(()=>{e&&S()},[e]);const S=async()=>{try{const{data:f,error:p}=await K.from("space_availability").select("*").eq("space_id",e).single();if(p)throw p;y({id:f.id,space_id:f.space_id,is_available:f.is_available,is_active:f.is_active,last_updated:f.last_updated})}catch(f){r(f instanceof Error?f.message:"Une erreur est survenue")}finally{o(!1)}};return{availability:u,loading:l,error:_,updateAvailability:async f=>{try{const{data:p,error:c}=await K.from("space_availability").update(f).eq("space_id",e).select().single();if(c)throw c;y({id:p.id,space_id:p.space_id,is_available:p.is_available,is_active:p.is_active,last_updated:p.last_updated})}catch(p){r(p instanceof Error?p.message:"Une erreur est survenue")}},refreshAvailability:S,checkAvailability:async({startDate:f,endDate:p,spaceId:c})=>{try{return o(!0),r(null),await se(async()=>{const{data:a,error:d}=await K.from("bookings").select("*").eq("space_id",c).or(`start_date.lte.${p.toISOString()},end_date.gte.${f.toISOString()}`);if(d)throw d;const{data:h,error:R}=await K.from("spaces").select("capacity").eq("id",c).single();if(R)throw R;const I=h.capacity||1,n=a.reduce((j,T)=>j+(T.capacity||1),0),b=Math.max(0,I-n);return{isAvailable:b>0,availableCapacity:b,totalCapacity:I}})}catch(s){return console.error("❌ Erreur lors de la vérification de disponibilité:",s),r(s.message),{isAvailable:!1,availableCapacity:0,totalCapacity:1}}finally{o(!1)}},checkAvailabilityForRange:async({startDate:f,endDate:p,spaceId:c})=>{try{return o(!0),r(null),await se(async()=>{const{data:a,error:d}=await K.from("bookings").select("*").eq("space_id",c).or(`start_date.lte.${p.toISOString()},end_date.gte.${f.toISOString()}`);if(d)throw d;return a})}catch(s){return console.error("❌ Erreur lors de la vérification de disponibilité:",s),r(s.message),[]}finally{o(!1)}}}}const Be=({selected:e,onSelect:u,timeSlots:y,selectedSlot:l,onSlotSelect:o,spaceId:_,space:r})=>{const[S,m]=i.useState(""),{setCustomDuration:O,getCurrentSlotDuration:w}=Ie(),{checkAvailability:f}=Fe(_||""),[p,c]=i.useState(null),s=i.useRef({}),a=i.useCallback((n,b,j)=>`${n.toISOString()}_${b}_${j}`,[]),d=i.useCallback(async()=>{if(!e||!_||!l){c(null);return}const n=w();if(n===0)return;const b=a(e,_,n),j=s.current[b];if(j&&Date.now()-j.timestamp<5*60*1e3){c(j.result);return}try{const T=await se(async()=>await f({startDate:e,endDate:new Date(e.getTime()+n*60*60*1e3),spaceId:_})),L={isAvailable:T.isAvailable,availableCapacity:T.availableCapacity,totalCapacity:T.totalCapacity};s.current[b]={timestamp:Date.now(),result:L},c(L)}catch(T){console.error("Erreur lors de la vérification de disponibilité:",T),c({isAvailable:!0,availableCapacity:1,totalCapacity:1})}},[e,_,l,w,a,f]);i.useEffect(()=>{const n=setTimeout(d,1e3);return()=>clearTimeout(n)},[d]),i.useEffect(()=>{if(l)if(typeof l=="string"&&l.startsWith("custom-")){const n=l.split("-")[1];m(n)}else m("")},[l]);const h=n=>{const b=parseInt(n);m(n),!isNaN(b)&&b>0&&(O(b),o(`custom-${b}`))},R=n=>{if(n==="custom"){if(S){const b=parseInt(S);if(!isNaN(b)&&b>0){o(`custom-${b}`);return}}m("1"),O(1),o("custom-1")}else o(n)},I=typeof l=="string"&&l.startsWith("custom-");return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx(Q,{children:"Date"}),t.jsx(Ee,{mode:"single",selected:e,onSelect:u,className:"rounded-md border mt-2",disabled:n=>n<new Date})]}),(r==null?void 0:r.pricing_type)==="hourly"?t.jsxs(t.Fragment,{children:[t.jsxs(de,{value:I?"custom":l,onValueChange:R,className:"grid grid-cols-2 gap-4 mt-2",children:[y.filter(n=>!n.label.includes("Matin")&&!n.label.includes("Après-midi")&&!n.label.includes("Journée")).map((n,b)=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ae,{value:n.value,id:n.value}),t.jsx(Q,{htmlFor:n.value,children:n.label})]},n.value||b)),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ae,{value:"custom",id:"custom"}),t.jsx(Q,{htmlFor:"custom",children:"Personnalisé"})]})]}),I&&t.jsxs("div",{className:"mt-4 flex items-center space-x-2",children:[t.jsx(ve,{type:"number",min:"1",max:"24",value:S,onChange:n=>h(n.target.value),placeholder:"Nombre d'heures",className:"w-40"}),t.jsx("span",{children:"heure(s)"})]})]}):t.jsx(de,{value:l,onValueChange:o,className:"grid grid-cols-2 gap-4 mt-2",children:y.map(n=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ae,{value:n.value,id:n.value}),t.jsx(Q,{htmlFor:n.value,children:n.label})]},n.value))}),p&&t.jsx("div",{className:pe("p-4 rounded-md border",p.isAvailable?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:t.jsx("p",{className:pe("text-sm font-medium",p.isAvailable?"text-green-800":"text-red-800"),children:p.isAvailable?`Disponible (${p.availableCapacity}/${p.totalCapacity} places)`:"Non disponible"})})]})},Le=({spaces:e,selected:u,onSelect:y,loading:l,getSpacePrice:o,getPricingLabel:_})=>t.jsxs(oe,{children:[t.jsxs(le,{children:[t.jsx(ce,{children:"Type d'espace"}),t.jsx(Se,{children:"Sélectionnez l'espace qui répond le mieux à vos besoins."})]}),t.jsx(ye,{children:l?t.jsx("p",{className:"text-center py-6",children:"Chargement des espaces en cours..."}):e.length===0?t.jsx("p",{className:"text-center py-6",children:"Aucun espace n'est disponible pour le moment."}):t.jsx(de,{value:u,onValueChange:y,children:t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:e.map(r=>t.jsxs(Q,{htmlFor:r.id,className:`relative block border p-4 rounded-lg transition-colors cursor-pointer hover:border-primary ${u===r.id?"border-primary bg-accent/20":"border-gray-200"}`,children:[t.jsx(ae,{value:r.id,id:r.id,className:"absolute right-4 top-4"}),t.jsx("div",{className:"font-medium text-lg mb-2",children:r.name}),t.jsxs("div",{className:"text-sm space-y-1 mb-3",children:[t.jsxs("p",{className:"text-gray-600",children:["HT: ",he(o(r).ht),_(r).replace("€","")]}),t.jsxs("p",{className:"text-gray-900",children:["TTC: ",he(o(r).ttc),_(r).replace("€","")]})]}),t.jsx("p",{className:"text-gray-500 text-sm line-clamp-2",children:r.description})]},r.id))})})})]});function qe(e){return e&&typeof e=="object"&&typeof e.id=="string"}function ne(e){return qe(e)?typeof e.name=="string"&&typeof e.pricing_type=="string":!1}function He(e){const[u,y]=i.useState(null),[l,o]=i.useState([]),[_,r]=i.useState(!1),[S,m]=i.useState(null),O=i.useCallback(async()=>{{m(new Error("ID de l'espace manquant"));return}},[e]),w=i.useCallback(async()=>{try{r(!0),m(null);const s=await $.get("/spaces/active");if(s.success&&s.data){const d=(Array.isArray(s.data)?s.data:[]).filter(ne);o(d)}else throw new Error(s.error||"Erreur lors de la récupération des espaces")}catch(s){console.error("Error fetching spaces:",s),m(s instanceof Error?s:new Error("Erreur inconnue"))}finally{r(!1)}},[]),f=i.useCallback(async s=>{try{r(!0),m(null);const a=await $.post("/spaces",s);if(a.success&&a.data){const d=a.data;if(ne(d))return o(h=>[...h,d]),v.success("Espace créé avec succès"),d;throw new Error("Données d'espace invalides")}else throw new Error(a.error||"Erreur lors de la création de l'espace")}catch(a){return console.error("Error creating space:",a),m(a instanceof Error?a:new Error("Erreur inconnue")),v.error("Erreur lors de la création de l'espace"),null}finally{r(!1)}},[]),p=i.useCallback(async(s,a)=>{try{r(!0),m(null);const d=await $.put(`/spaces/${s}`,a);if(d.success&&d.data){const h=d.data;if(ne(h))return o(R=>R.map(I=>I.id===s?h:I)),e===s&&y(h),v.success("Espace mis à jour avec succès"),h;throw new Error("Données d'espace invalides")}else throw new Error(d.error||"Erreur lors de la mise à jour de l'espace")}catch(d){return console.error("Error updating space:",d),m(d instanceof Error?d:new Error("Erreur inconnue")),v.error("Erreur lors de la mise à jour de l'espace"),null}finally{r(!1)}},[e]),c=i.useCallback(async s=>{try{r(!0),m(null);const a=await $.delete(`/spaces/${s}`);if(a.success)return o(d=>d.filter(h=>h.id!==s)),e===s&&y(null),v.success("Espace supprimé avec succès"),!0;throw new Error(a.error||"Erreur lors de la suppression de l'espace")}catch(a){return console.error("Error deleting space:",a),m(a instanceof Error?a:new Error("Erreur inconnue")),v.error("Erreur lors de la suppression de l'espace"),!1}finally{r(!1)}},[e]);return i.useEffect(()=>{w()},[e,O,w]),{space:u,spaces:l,loading:_,error:S,createSpace:f,updateSpace:p,deleteSpace:c,refetch:w}}function Pe(e){const[u,y]=i.useState([]),[l,o]=i.useState(!1),[_,r]=i.useState(null);return i.useEffect(()=>{if(!e){y([{id:"1",label:"09:00 - 10:00",startTime:"09:00",endTime:"10:00",price:0,isAvailable:!0,value:"1"},{id:"2",label:"10:00 - 11:00",startTime:"10:00",endTime:"11:00",price:0,isAvailable:!0,value:"2"},{id:"3",label:"11:00 - 12:00",startTime:"11:00",endTime:"12:00",price:0,isAvailable:!0,value:"3"},{id:"4",label:"14:00 - 15:00",startTime:"14:00",endTime:"15:00",price:0,isAvailable:!0,value:"4"},{id:"5",label:"15:00 - 16:00",startTime:"15:00",endTime:"16:00",price:0,isAvailable:!0,value:"5"},{id:"6",label:"16:00 - 17:00",startTime:"16:00",endTime:"17:00",price:0,isAvailable:!0,value:"6"}]);return}(async()=>{try{o(!0),r(null),y([{id:"1",label:"09:00 - 10:00",startTime:"09:00",endTime:"10:00",price:0,isAvailable:!0,value:"1"},{id:"2",label:"10:00 - 11:00",startTime:"10:00",endTime:"11:00",price:0,isAvailable:!0,value:"2"},{id:"3",label:"11:00 - 12:00",startTime:"11:00",endTime:"12:00",price:0,isAvailable:!0,value:"3"},{id:"4",label:"14:00 - 15:00",startTime:"14:00",endTime:"15:00",price:0,isAvailable:!0,value:"4"},{id:"5",label:"15:00 - 16:00",startTime:"15:00",endTime:"16:00",price:0,isAvailable:!0,value:"5"},{id:"6",label:"16:00 - 17:00",startTime:"16:00",endTime:"17:00",price:0,isAvailable:!0,value:"6"}])}catch(m){console.error("Erreur chargement créneaux:",m),r("Erreur lors du chargement des créneaux")}finally{o(!1)}})()},[e]),{timeSlots:u,loading:l,error:_}}const Ve=Ae({space_id:re().min(1,"Espace requis"),start_time:re().min(1,"Début requis"),end_time:re().min(1,"Fin requise"),status:ke(["pending","confirmed","cancelled"]).optional(),total_price_ht:ge().min(0).optional(),total_price_ttc:ge().min(0).optional(),timeSlot:re().optional()});function Me(e){const{space:u,spaces:y,loading:l}=He(e),[o,_]=i.useState(null),[r,S]=i.useState(""),m=i.useCallback(E=>{_(E),S(E.id)},[]),O=i.useCallback(E=>{_(E),S(E.id)},[]),[w,f]=i.useState(!1),p=De({resolver:Ce(Ve),defaultValues:{space_id:(u==null?void 0:u.id)||"",start_time:"",end_time:"",status:"pending",total_price_ht:0,total_price_ttc:0,timeSlot:""}}),[c,s]=i.useState(new Date),[a,d]=i.useState({from:new Date,to:void 0}),[h,R]=i.useState(["monday","tuesday","wednesday","thursday","friday"]),[I,n]=i.useState(!1),[b,j]=i.useState(!1),[T,L]=i.useState(!1),ie=_e(),{createPaymentSession:D}=xe(),{timeSlots:C}=Pe(r),[F,M]=i.useState("");i.useEffect(()=>{u&&(s(void 0),d({from:new Date,to:void 0}),M(""),n(!1),R(["monday","tuesday","wednesday","thursday","friday"]),L(!1))},[u]);const z=async E=>{try{const g=await $.post("/bookings",E);if(!g.success)throw new Error(g.error||"Erreur lors de la création de la réservation");return g.data}catch(g){throw console.error("Erreur création réservation:",g),g}},W=async(E,g)=>{try{const A={status:g,updated_at:new Date().toISOString()},x=await $.put(`/bookings/${E}`,{status:g});if(!x.success)throw new Error(x.error||"Erreur lors de la mise à jour du statut")}catch(A){throw console.error("Erreur mise à jour statut:",A),A}},q=async(E,g,A)=>{try{const x=await $.get(`/spaces/${E}`);if(!x.success||!x.data)throw new Error("Espace non trouvé");const k=x.data,N=await $.get(`/bookings?space_id=${E}`);if(!N.success)throw new Error("Erreur lors de la récupération des réservations");const J=N.data||[];return{isAvailable:((J==null?void 0:J.filter(P=>isValidBooking(P)&&P.start_time<A&&P.end_time>g))||[]).length===0,space:k}}catch(x){throw console.error("Erreur vérification disponibilité:",x),x}},U=async E=>{f(!0);try{const g={...E,status:E.status||"pending"},A=await $.post("/bookings",g);if(!A.success)throw new Error(A.error||"Erreur lors de la sauvegarde");v.success("Réservation sauvegardée")}catch(g){v.error("Erreur lors de la sauvegarde de la réservation"),console.error(g)}finally{f(!1)}},ue=(E,g)=>E.find(A=>A.value===g);return{form:p,loadingForm:w,isSubmitting:b,termsAccepted:T,setTermsAccepted:L,date:c,setDate:s,dateRange:a,setDateRange:d,selectedDays:h,setSelectedDays:R,isRecurring:I,setIsRecurring:n,timeSlots:C,timeSlot:F,setTimeSlot:M,selectedSpace:o,setSelectedSpace:_,handleSpaceSelect:m,handleSpaceChange:O,handleSubmit:async E=>{if(E.preventDefault(),!o||!F){v.error("Veuillez sélectionner un espace et un créneau horaire");return}if(!T){v.error("Veuillez accepter les conditions générales");return}j(!0);try{let g;if(F.startsWith("custom-")){const k=parseInt(F.split("-")[1]);g={id:`custom-${k}`,value:F,label:`${k} heure${k>1?"s":""}`,duration:k,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:0}}else g=ue(C,F);if(!g)throw new Error("Créneau horaire invalide");const A={id:"current_user"},x=u;if(!x)throw new Error("Espace non trouvé ou invalide");if(I&&(a!=null&&a.from)&&(a!=null&&a.to)){const k=[],N=new Date(a.from),J=new Date(a.to),H={sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6};for(;N<=J;){const B=N.getDay(),G=Object.keys(H).find(V=>H[V]===B);if(G&&h.includes(G)){const{startTime:V,endTime:me}=Z(new Date(N),g.label);if(!(await q(x.id,V.toISOString(),me.toISOString())).isAvailable){N.setDate(N.getDate()+1);continue}k.push({user_id:A.id,space_id:x.id,start_time:V.toISOString(),end_time:me.toISOString(),total_price_ht:te(x,g.duration).ht,total_price_ttc:te(x,g.duration).ttc,status:"confirmed"})}N.setDate(N.getDate()+1)}if(k.length===0)throw new Error("Aucun créneau disponible pour la période sélectionnée");const P=k.map(B=>({user_id:B.user_id,space_id:B.space_id,start_time:B.start_time,end_time:B.end_time,total_price_ht:B.total_price_ht,total_price_ttc:B.total_price_ttc,status:"pending"})),Y=await Promise.all(P.map(z));v.success(`${Y.length} réservations créées avec succès !`)}else{const{startTime:k,endTime:N}=Z(c,g.label);if(!(await q(x.id,k.toISOString(),N.toISOString())).isAvailable){v.error("Cet espace n'est pas disponible pour la période sélectionnée"),j(!1);return}const H=te(x,g.duration),P={user_id:A.id,space_id:x.id,start_time:k.toISOString(),end_time:N.toISOString(),total_price_ht:H.ht,total_price_ttc:H.ttc,status:"pending"},Y=await z(P),B=A.email||"client@example.com";try{const{url:G,mode:V}=await D(Y.id,Math.round(H.ttc*100),B,{booking_id:Y.id,space_name:x.name||"Espace",start_time:k.toISOString(),end_time:N.toISOString()});v.info("Redirection vers la page de paiement..."),window.location.href=G;return}catch(G){console.error("Erreur lors de la création de la session de paiement:",G),v.error("Impossible de créer la session de paiement. Veuillez réessayer.");try{await W(Y.id,"cancelled")}catch(V){console.warn("Erreur lors de l'annulation de la réservation:",V)}j(!1);return}}setTimeout(()=>{ie("/dashboard")},1500)}catch(g){console.error("Error creating booking:",g),v.error(g instanceof Error?g.message:"Erreur lors de la réservation")}finally{j(!1)}},onSubmit:U,getSelectedTimeSlot:ue,spaceType:r,setSpaceType:S,spaces:y,loading:l,getSpacePrice:te,getPricingLabel:je}}const et=()=>{const{id:e}=we(),u=_e(),[y,l]=i.useState(!0),[o,_]=i.useState(null),{date:r,setDate:S,spaceType:m,setSpaceType:O,timeSlot:w,setTimeSlot:f,spaces:p,timeSlots:c,getSpacePrice:s,getPricingLabel:a,isSubmitting:d,loading:h,termsAccepted:R,setTermsAccepted:I}=Me();i.useEffect(()=>{(async()=>{try{if(!e)return;const C=await $.get(`/bookings/${e}`);if(!C.success){v.error("Réservation non trouvée"),u("/dashboard");return}_(C.data),O(C.data.space_id),S(new Date(C.data.start_date))}catch(C){console.error("Error fetching booking:",C),v.error("Erreur lors du chargement de la réservation"),u("/dashboard")}finally{l(!1)}})()},[e,u,S,O,f]),i.useEffect(()=>{if(c.length>0&&!o&&!w){f(c[0].id);return}if(!o||c.length===0)return;const D=new Date(o.start_date),C=new Date(o.end_date),F=new Date(D.getTime()+D.getTimezoneOffset()*6e4),M=new Date(C.getTime()+C.getTimezoneOffset()*6e4),z=F.getHours();M.getHours();const W=c.find(q=>parseInt(q.startTime.split(":")[0])===z);W?f(W.id):c.length>0&&f(c[0].id)},[o,c,f]);const n=async()=>{try{if(!o||!m||!r||!w){v.error("Veuillez remplir tous les champs");return}const D=p.find(U=>U.id===m);if(!D){v.error("Espace non trouvé");return}const C=c.find(U=>U.id===w);if(!C){v.error("Créneau horaire non trouvé");return}const{startTime:F,endTime:M}=Z(r,C.label),z=s(D),W={space_id:D.id,start_date:F.toISOString(),end_date:M.toISOString(),total_price:z.ht,status:"pending"},q=await $.put(`/bookings/${o.id}`,W);if(!q.success)throw new Error(q.error||"Erreur lors de la mise à jour");v.success("Réservation modifiée avec succès"),u("/dashboard")}catch(D){console.error("Error updating booking:",D),v.error("Erreur lors de la modification de la réservation")}};if(y)return t.jsxs("div",{className:"container mx-auto px-4 py-8",children:[t.jsx("div",{className:"mb-6",children:t.jsxs(ee,{variant:"outline",size:"sm",onClick:()=>u("/dashboard"),className:"flex items-center gap-2",children:[t.jsx(fe,{className:"h-4 w-4"}),"Retour au tableau de bord"]})}),t.jsx(oe,{children:t.jsx(le,{children:t.jsx(ce,{children:"Chargement..."})})})]});const b=p.find(D=>D.id===m),j=s(b),T=c.find(D=>D.id===w),L=b?{...b,price:j.ttc,description:b.description??"",image_url:b.image_url??"",is_available:b.is_active??!0}:void 0,ie=T&&r?{id:T.id,label:T.label,startTime:Z(r,T.label).startTime.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),endTime:Z(r,T.label).endTime.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),price:j.ttc,isAvailable:T.is_available??!0}:void 0;return t.jsxs("div",{className:"container mx-auto px-4 py-8",children:[t.jsx("div",{className:"mb-6",children:t.jsxs(ee,{variant:"outline",size:"sm",onClick:()=>u("/dashboard"),className:"flex items-center gap-2",children:[t.jsx(fe,{className:"h-4 w-4"}),"Retour au tableau de bord"]})}),t.jsxs(oe,{children:[t.jsx(le,{children:t.jsx(ce,{children:"Modifier la réservation"})}),t.jsx(ye,{children:t.jsxs("form",{onSubmit:n,className:"grid gap-6",children:[t.jsx(Le,{spaces:p,selected:m,onSelect:O,loading:h,getSpacePrice:s,getPricingLabel:a}),m&&t.jsx(Be,{selected:r,onSelect:S,timeSlots:c,selectedSlot:w,onSlotSelect:f}),L&&t.jsx(Te,{space:L,selectedDays:[r||new Date],selectedTimeSlot:ie,isRecurring:!1,dateRange:r?{from:r,to:r}:void 0,termsAccepted:R,onTermsChange:I,onSubmit:n}),t.jsxs("div",{className:"flex justify-end gap-4",children:[t.jsx(ee,{type:"button",variant:"outline",onClick:()=>u("/dashboard"),children:"Annuler"}),t.jsx(ee,{type:"button",disabled:d||!m||!r||!w,onClick:n,children:"Modifier la réservation"})]})]})})]})]})};export{et as default};
