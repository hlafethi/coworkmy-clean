import{k as M,l as V,r as c,u as o,g as y,j as e,B as j,A as I,C as p,a as h,e as _,b as f,m as l,I as d,T as $}from"./index-ORzpbH52.js";import{C as B,A as O,L as R}from"./LogoUploadSimple-Dpusdzof.js";import{B as T}from"./avatar-BvkwrKon.js";import{U as H}from"./user-Cszy5Zfh.js";import{M as G}from"./map-pin-DwN9S1MJ.js";const Y=()=>{const m=M(),{user:t,profile:r,loading:A,updateProfile:N}=V(),[L,C]=c.useState(!0),[b,E]=c.useState(!1),[s,x]=c.useState({first_name:"",last_name:"",email:"",phone:"",phone_number:"",company:"",company_name:"",city:"",address:"",address_street:"",address_city:"",address_postal_code:"",address_country:"",birth_date:"",presentation:"",profile_picture:"",logo_url:"",avatar_url:""});c.useEffect(()=>{if(!(typeof t>"u")){if(t===null){o.error("Vous devez être connecté pour accéder à cette page"),m("/auth/login");return}r?(x({first_name:r.first_name||"",last_name:r.last_name||"",email:r.email||"",phone:r.phone||"",phone_number:r.phone_number||"",company:r.company||"",company_name:r.company_name||"",city:r.city||"",address:r.address||"",address_street:r.address_street||"",address_city:r.address_city||"",address_postal_code:r.address_postal_code||"",address_country:r.address_country||"",birth_date:r.birth_date?r.birth_date.split("T")[0]:"",presentation:r.presentation||"",profile_picture:r.profile_picture||"",logo_url:r.logo_url||"",avatar_url:r.avatar_url||""}),C(!1)):(o.error("Erreur lors du chargement du profil"),C(!1))}},[m,t,r]),c.useEffect(()=>{r&&x(n=>({...n,avatar_url:r.avatar_url||"",logo_url:r.logo_url||""}))},[r==null?void 0:r.avatar_url,r==null?void 0:r.logo_url]);const F=c.useCallback(async n=>{if(t)try{const a=await y.put(`/users/${t.id}`,{...n,updated_at:new Date().toISOString()});a.success?o.success("Modifications sauvegardées automatiquement",{duration:2e3}):(console.error("Erreur sauvegarde automatique:",a.error),o.error("Erreur lors de la sauvegarde automatique"))}catch(a){console.error("❌ Erreur lors de la sauvegarde automatique:",a),o.error("Erreur lors de la sauvegarde automatique")}},[t]),[g,D]=c.useState(!0),[v,q]=c.useState(!1);c.useEffect(()=>{if(!t||!s.first_name||g||!v)return;const{avatar_url:n,logo_url:a,...u}=s;if(!Object.values(u).some(w=>w&&w.trim()!==""))return;const z=setTimeout(()=>{F(u)},3e3);return()=>clearTimeout(z)},[s.first_name,s.last_name,s.email,s.phone,s.phone_number,s.company,s.company_name,s.city,s.address,s.address_street,s.address_city,s.address_postal_code,s.address_country,s.birth_date,s.presentation,F,t,g,v]),c.useEffect(()=>{if(s.first_name&&g){const n=setTimeout(()=>{D(!1)},2e3);return()=>clearTimeout(n)}},[s.first_name,g]);const U=async n=>{n.preventDefault(),E(!0);try{if(!t){o.error("Vous devez être connecté pour modifier votre profil");return}const a={first_name:s.first_name,last_name:s.last_name,email:s.email,phone:s.phone,phone_number:s.phone_number,company:s.company,company_name:s.company_name,city:s.city,address:s.address,address_street:s.address_street,address_city:s.address_city,address_postal_code:s.address_postal_code,address_country:s.address_country,birth_date:s.birth_date||null,presentation:s.presentation,profile_picture:s.profile_picture,logo_url:s.logo_url,avatar_url:s.avatar_url},u=await y.put(`/users/${t.id}`,a);if(!u.success){if(u.error==="Token invalide"||u.error==="Accès non autorisé"){o.error("Session expirée. Veuillez vous reconnecter."),m("/auth/login");return}o.error(`Erreur lors de la mise à jour du profil: ${u.error}`);return}o.success("Profil mis à jour avec succès"),m("/profile")}catch(a){console.error("Error updating profile:",a),o.error("Erreur lors de la mise à jour du profil")}finally{E(!1)}},i=n=>{const{name:a,value:u}=n.target;x(S=>({...S,[a]:u})),v||q(!0)},k=async n=>{if(x(a=>({...a,avatar_url:n})),N({avatar_url:n}),t)try{(await y.put(`/users/${t.id}`,{avatar_url:n,updated_at:new Date().toISOString()})).success?o.success("Photo de profil mise à jour"):o.error("Erreur lors de la mise à jour de la photo de profil")}catch(a){console.error("Erreur lors de la mise à jour de l'avatar:",a),o.error("Erreur lors de la mise à jour de la photo de profil")}},P=async n=>{if(x(a=>({...a,logo_url:n})),N({logo_url:n}),t)try{(await y.put(`/users/${t.id}`,{logo_url:n,updated_at:new Date().toISOString()})).success?o.success("Logo d'entreprise mis à jour"):o.error("Erreur lors de la mise à jour du logo")}catch(a){console.error("Erreur lors de la mise à jour du logo:",a),o.error("Erreur lors de la mise à jour du logo")}};return A&&!r||L&&!s.first_name||typeof t>"u"?e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>m("/profile"),className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4"}),"Retour au profil"]})}),e.jsx(p,{children:e.jsx(h,{children:e.jsx(_,{children:"Chargement..."})})})]}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>m("/profile"),className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4"}),"Retour au profil"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Modifier le profil"})]}),e.jsx(j,{variant:"outline",onClick:()=>m("/profile"),children:"Annuler"})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(h,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5"}),"Photo de profil"]})}),e.jsx(f,{children:t&&e.jsx(O,{currentAvatarUrl:s.avatar_url,userId:t.id,onAvatarUpdated:k})})]}),e.jsxs(p,{children:[e.jsx(h,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5"}),"Logo d'entreprise"]})}),e.jsx(f,{children:t&&e.jsx(R,{currentLogoUrl:s.logo_url,userId:t.id,onLogoUpdated:P})})]})]}),e.jsxs(p,{children:[e.jsx(h,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),"Informations personnelles"]})}),e.jsx(f,{children:e.jsxs("form",{onSubmit:U,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"first_name",children:"Prénom"}),e.jsx(d,{id:"first_name",name:"first_name",value:s.first_name,onChange:i,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"last_name",children:"Nom"}),e.jsx(d,{id:"last_name",name:"last_name",value:s.last_name,onChange:i,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"email",children:"Email"}),e.jsx(d,{id:"email",name:"email",type:"email",value:s.email,onChange:i,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"birth_date",children:"Date de naissance"}),e.jsx(d,{id:"birth_date",name:"birth_date",type:"date",value:s.birth_date,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"phone",children:"Téléphone"}),e.jsx(d,{id:"phone",name:"phone",value:s.phone,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"phone_number",children:"Numéro de téléphone"}),e.jsx(d,{id:"phone_number",name:"phone_number",value:s.phone_number,onChange:i})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"presentation",children:"Présentation"}),e.jsx($,{id:"presentation",name:"presentation",value:s.presentation,onChange:i,rows:4,placeholder:"Parlez-nous de vous..."})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>m("/profile"),children:"Annuler"}),e.jsx(j,{type:"submit",disabled:b,children:b?"Enregistrement...":"Enregistrer"})]})]})})]}),e.jsxs(p,{children:[e.jsx(h,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5"}),"Informations professionnelles"]})}),e.jsx(f,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"company",children:"Entreprise"}),e.jsx(d,{id:"company",name:"company",value:s.company,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"company_name",children:"Nom de l'entreprise"}),e.jsx(d,{id:"company_name",name:"company_name",value:s.company_name,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"city",children:"Ville"}),e.jsx(d,{id:"city",name:"city",value:s.city,onChange:i})]})]})})]}),e.jsxs(p,{children:[e.jsx(h,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5"}),"Adresse"]})}),e.jsx(f,{children:e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"address",children:"Adresse complète"}),e.jsx(d,{id:"address",name:"address",value:s.address,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"address_street",children:"Rue"}),e.jsx(d,{id:"address_street",name:"address_street",value:s.address_street,onChange:i})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"address_city",children:"Ville"}),e.jsx(d,{id:"address_city",name:"address_city",value:s.address_city,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"address_postal_code",children:"Code postal"}),e.jsx(d,{id:"address_postal_code",name:"address_postal_code",value:s.address_postal_code,onChange:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"address_country",children:"Pays"}),e.jsx(d,{id:"address_country",name:"address_country",value:s.address_country,onChange:i})]})]})]})})]})]})]})};export{Y as default};
