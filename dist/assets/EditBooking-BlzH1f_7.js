import{r as i,s as K,j as t,n as Q,I as ve,h as pe,C as le,a as ce,e as de,f as Se,b as ye,g as F,u as S,k as _e,as as we,B as ee,A as ge}from"./index-DjQDvwSR.js";import{C as Ee,u as Te,B as xe}from"./useStripePayment-BG3-9l2J.js";import{R as ue,a as ae}from"./use-toast-8Za1Tsgn.js";import"./client-DHZYSnFT.js";import{f as fe,g as Ce,a as te,b as Z}from"./bookingUtils-yZhmP6yH.js";import{u as De}from"./index.esm-B955QOgp.js";import{a as je,o as Ae,s as re,n as he,e as ke}from"./types-hJPI8LHl.js";import"./stripeUtils-Dyfdw-WJ.js";const be=e=>({id:e.id,value:e.id,label:e.label,price:0,duration:e.duration,start_time:e.start_time,end_time:e.end_time,is_available:!0,space_id:"",display_order:e.display_order}),Ne=e=>({id:`custom-${e}`,value:`custom-${e}`,label:`${e} heure${e>1?"s":""}`,duration:e,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:0}),Ie=[{id:"1",label:"9h00 - 10h00",start_time:"09:00",end_time:"10:00",display_order:1,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"2",label:"10h00 - 11h00",start_time:"10:00",end_time:"11:00",display_order:2,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"3",label:"11h00 - 12h00",start_time:"11:00",end_time:"12:00",display_order:3,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"4",label:"14h00 - 15h00",start_time:"14:00",end_time:"15:00",display_order:4,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"5",label:"15h00 - 16h00",start_time:"15:00",end_time:"16:00",display_order:5,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{id:"6",label:"16h00 - 17h00",start_time:"16:00",end_time:"17:00",display_order:6,duration:1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}],X=[{id:"morning",label:"Matin (9h-13h)",duration:4,price:0,start_time:"09:00",end_time:"13:00",is_available:!0,space_id:"",display_order:1},{id:"afternoon",label:"AprÃ¨s-midi (14h-18h)",duration:4,price:0,start_time:"14:00",end_time:"18:00",is_available:!0,space_id:"",display_order:2},{id:"full-day",label:"JournÃ©e complÃ¨te (9h-18h)",duration:9,price:0,start_time:"09:00",end_time:"18:00",is_available:!0,space_id:"",display_order:3},{id:"monthly",label:"Mois complet",duration:720,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:4},{id:"quarter",label:"Trimestre",duration:2160,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:5},{id:"yearly",label:"AnnÃ©e",duration:8760,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:6}],Oe=e=>{const[m,y]=i.useState([]),[u,n]=i.useState(""),[v,r]=i.useState(0),[E,l]=i.useState(!0),[I,_]=i.useState(null);return i.useEffect(()=>{(async()=>{var s;try{l(!0),_(null);let a=[];if(!e||!["hourly","half_day","daily","monthly","quarter","yearly"].includes(e))throw new Error("Type de tarification invalide");switch(e){case"hourly":const{data:c}=await K.from("time_slots").select("*").order("display_order",{ascending:!0});a=c!=null&&c.length?c.map(be):Ie.map(be);break;case"half_day":a=X.filter(f=>f.id==="morning"||f.id==="afternoon");break;case"daily":a=X.filter(f=>f.id==="full-day");break;case"monthly":a=X.filter(f=>f.id==="monthly");break;case"quarter":a=X.filter(f=>f.id==="quarter");break;case"yearly":a=X.filter(f=>f.id==="yearly");break;default:a=[]}y(a),n(((s=a[0])==null?void 0:s.id)||"")}catch{_("Erreur inconnue"),y([]),n("")}finally{l(!1)}})()},[e]),{timeSlots:m,selectedSlot:u,setSelectedSlot:n,customHours:v,setCustomDuration:d=>{r(d);const s=Ne(d);y(a=>[...a.filter(f=>!String(f.id).startsWith("custom-")),s]),n(s.id)},loading:E,error:I,getCurrentSlotDuration:()=>{if(u.startsWith("custom-")){const s=parseInt(u.split("-")[1]);return isNaN(s)?0:s}const d=m.find(s=>s.id===u);return(d==null?void 0:d.duration)||0}}},Re=3,$e=1e3;async function se(e,m=Re,y=$e){try{return await e()}catch(u){if(m>0&&u instanceof Error&&(u.message.includes("ERR_INSUFFICIENT_RESOURCES")||u.message.includes("Failed to fetch")||u.message.includes("Invalid Refresh Token")||u.message.includes("JWT expired")))return console.warn(`Retrying operation after error: ${u.message}. Retries left: ${m}`),await new Promise(n=>setTimeout(n,y)),se(e,m-1,y*2);throw u}}function Fe(e){const[m,y]=i.useState(null),[u,n]=i.useState(!0),[v,r]=i.useState(null);i.useEffect(()=>{e&&E()},[e]);const E=async()=>{try{const{data:g,error:p}=await K.from("space_availability").select("*").eq("space_id",e).single();if(p)throw p;y({id:g.id,space_id:g.space_id,is_available:g.is_available,is_active:g.is_active,last_updated:g.last_updated})}catch(g){r(g instanceof Error?g.message:"Une erreur est survenue")}finally{n(!1)}};return{availability:m,loading:u,error:v,updateAvailability:async g=>{try{const{data:p,error:d}=await K.from("space_availability").update(g).eq("space_id",e).select().single();if(d)throw d;y({id:p.id,space_id:p.space_id,is_available:p.is_available,is_active:p.is_active,last_updated:p.last_updated})}catch(p){r(p instanceof Error?p.message:"Une erreur est survenue")}},refreshAvailability:E,checkAvailability:async({startDate:g,endDate:p,spaceId:d})=>{try{return n(!0),r(null),await se(async()=>{const{data:a,error:c}=await K.from("bookings").select("*").eq("space_id",d).or(`start_date.lte.${p.toISOString()},end_date.gte.${g.toISOString()}`);if(c)throw c;const{data:f,error:R}=await K.from("spaces").select("capacity").eq("id",d).single();if(R)throw R;const O=f.capacity||1,o=a.reduce((D,C)=>D+(C.capacity||1),0),b=Math.max(0,O-o);return{isAvailable:b>0,availableCapacity:b,totalCapacity:O}})}catch(s){return console.error("âŒ Erreur lors de la vÃ©rification de disponibilitÃ©:",s),r(s.message),{isAvailable:!1,availableCapacity:0,totalCapacity:1}}finally{n(!1)}},checkAvailabilityForRange:async({startDate:g,endDate:p,spaceId:d})=>{try{return n(!0),r(null),await se(async()=>{const{data:a,error:c}=await K.from("bookings").select("*").eq("space_id",d).or(`start_date.lte.${p.toISOString()},end_date.gte.${g.toISOString()}`);if(c)throw c;return a})}catch(s){return console.error("âŒ Erreur lors de la vÃ©rification de disponibilitÃ©:",s),r(s.message),[]}finally{n(!1)}}}}const Le=({selected:e,onSelect:m,timeSlots:y,selectedSlot:u,onSlotSelect:n,spaceId:v,space:r})=>{console.log("ğŸ” DateSelector reÃ§u:",{timeSlotsLength:y.length,timeSlots:y,selectedSlot:u});const[E,l]=i.useState(""),{setCustomDuration:I,getCurrentSlotDuration:_}=Oe(),{checkAvailability:g}=Fe(v||""),[p,d]=i.useState(null),s=i.useRef({}),a=i.useCallback((o,b,D)=>`${o.toISOString()}_${b}_${D}`,[]),c=i.useCallback(async()=>{if(!e||!v||!u){d(null);return}const o=_();if(o===0)return;const b=a(e,v,o),D=s.current[b];if(D&&Date.now()-D.timestamp<5*60*1e3){d(D.result);return}try{const C=await se(async()=>await g({startDate:e,endDate:new Date(e.getTime()+o*60*60*1e3),spaceId:v})),q={isAvailable:C.isAvailable,availableCapacity:C.availableCapacity,totalCapacity:C.totalCapacity};s.current[b]={timestamp:Date.now(),result:q},d(q)}catch(C){console.error("Erreur lors de la vÃ©rification de disponibilitÃ©:",C),d({isAvailable:!0,availableCapacity:1,totalCapacity:1})}},[e,v,u,_,a,g]);i.useEffect(()=>{const o=setTimeout(c,1e3);return()=>clearTimeout(o)},[c]),i.useEffect(()=>{if(u)if(typeof u=="string"&&u.startsWith("custom-")){const o=u.split("-")[1];l(o)}else l("")},[u]);const f=o=>{const b=parseInt(o);l(o),!isNaN(b)&&b>0&&(I(b),n(`custom-${b}`))},R=o=>{if(o==="custom"){if(E){const b=parseInt(E);if(!isNaN(b)&&b>0){n(`custom-${b}`);return}}l("1"),I(1),n("custom-1")}else n(o)},O=typeof u=="string"&&u.startsWith("custom-");return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx(Q,{children:"Date"}),t.jsx(Ee,{mode:"single",selected:e,onSelect:m,className:"rounded-md border mt-2",disabled:o=>o<new Date})]}),(r==null?void 0:r.pricing_type)==="hourly"?t.jsxs(t.Fragment,{children:[t.jsxs(ue,{value:O?"custom":u,onValueChange:R,className:"grid grid-cols-2 gap-4 mt-2",children:[y.filter(o=>!o.label.includes("Matin")&&!o.label.includes("AprÃ¨s-midi")&&!o.label.includes("JournÃ©e")).map((o,b)=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ae,{value:o.value,id:o.value}),t.jsx(Q,{htmlFor:o.value,children:o.label})]},o.value||b)),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ae,{value:"custom",id:"custom"}),t.jsx(Q,{htmlFor:"custom",children:"PersonnalisÃ©"})]})]}),O&&t.jsxs("div",{className:"mt-4 flex items-center space-x-2",children:[t.jsx(ve,{type:"number",min:"1",max:"24",value:E,onChange:o=>f(o.target.value),placeholder:"Nombre d'heures",className:"w-40"}),t.jsx("span",{children:"heure(s)"})]})]}):t.jsx(ue,{value:u,onValueChange:n,className:"grid grid-cols-2 gap-4 mt-2",children:y.map(o=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ae,{value:o.value,id:o.value}),t.jsx(Q,{htmlFor:o.value,children:o.label})]},o.value))}),p&&t.jsx("div",{className:pe("p-4 rounded-md border",p.isAvailable?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:t.jsx("p",{className:pe("text-sm font-medium",p.isAvailable?"text-green-800":"text-red-800"),children:p.isAvailable?`Disponible (${p.availableCapacity}/${p.totalCapacity} places)`:"Non disponible"})})]})},Be=({spaces:e,selected:m,onSelect:y,loading:u,getSpacePrice:n,getPricingLabel:v})=>t.jsxs(le,{children:[t.jsxs(ce,{children:[t.jsx(de,{children:"Type d'espace"}),t.jsx(Se,{children:"SÃ©lectionnez l'espace qui rÃ©pond le mieux Ã  vos besoins."})]}),t.jsx(ye,{children:u?t.jsx("p",{className:"text-center py-6",children:"Chargement des espaces en cours..."}):e.length===0?t.jsx("p",{className:"text-center py-6",children:"Aucun espace n'est disponible pour le moment."}):t.jsx(ue,{value:m,onValueChange:y,children:t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:e.map(r=>t.jsxs(Q,{htmlFor:r.id,className:`relative block border p-4 rounded-lg transition-colors cursor-pointer hover:border-primary ${m===r.id?"border-primary bg-accent/20":"border-gray-200"}`,children:[t.jsx(ae,{value:r.id,id:r.id,className:"absolute right-4 top-4"}),t.jsx("div",{className:"font-medium text-lg mb-2",children:r.name}),t.jsxs("div",{className:"text-sm space-y-1 mb-3",children:[t.jsxs("p",{className:"text-gray-600",children:["HT: ",fe(n(r).ht),v(r).replace("â‚¬","")]}),t.jsxs("p",{className:"text-gray-900",children:["TTC: ",fe(n(r).ttc),v(r).replace("â‚¬","")]})]}),t.jsx("p",{className:"text-gray-500 text-sm line-clamp-2",children:r.description})]},r.id))})})})]});function qe(e){return e&&typeof e=="object"&&typeof e.id=="string"}function oe(e){return qe(e)?typeof e.name=="string"&&typeof e.pricing_type=="string":!1}function He(e){const[m,y]=i.useState(null),[u,n]=i.useState([]),[v,r]=i.useState(!1),[E,l]=i.useState(null),I=i.useCallback(async()=>{{l(new Error("ID de l'espace manquant"));return}},[e]),_=i.useCallback(async()=>{try{r(!0),l(null),console.log("Fetching spaces...");const s=await F.get("/spaces/active");if(s.success&&s.data){const c=(Array.isArray(s.data)?s.data:[]).filter(oe);n(c)}else throw new Error(s.error||"Erreur lors de la rÃ©cupÃ©ration des espaces")}catch(s){console.error("Error fetching spaces:",s),l(s instanceof Error?s:new Error("Erreur inconnue"))}finally{r(!1)}},[]),g=i.useCallback(async s=>{try{r(!0),l(null);const a=await F.post("/spaces",s);if(a.success&&a.data){const c=a.data;if(oe(c))return n(f=>[...f,c]),S.success("Espace crÃ©Ã© avec succÃ¨s"),c;throw new Error("DonnÃ©es d'espace invalides")}else throw new Error(a.error||"Erreur lors de la crÃ©ation de l'espace")}catch(a){return console.error("Error creating space:",a),l(a instanceof Error?a:new Error("Erreur inconnue")),S.error("Erreur lors de la crÃ©ation de l'espace"),null}finally{r(!1)}},[]),p=i.useCallback(async(s,a)=>{try{r(!0),l(null);const c=await F.put(`/spaces/${s}`,a);if(c.success&&c.data){const f=c.data;if(oe(f))return n(R=>R.map(O=>O.id===s?f:O)),e===s&&y(f),S.success("Espace mis Ã  jour avec succÃ¨s"),f;throw new Error("DonnÃ©es d'espace invalides")}else throw new Error(c.error||"Erreur lors de la mise Ã  jour de l'espace")}catch(c){return console.error("Error updating space:",c),l(c instanceof Error?c:new Error("Erreur inconnue")),S.error("Erreur lors de la mise Ã  jour de l'espace"),null}finally{r(!1)}},[e]),d=i.useCallback(async s=>{try{r(!0),l(null);const a=await F.delete(`/spaces/${s}`);if(a.success)return n(c=>c.filter(f=>f.id!==s)),e===s&&y(null),S.success("Espace supprimÃ© avec succÃ¨s"),!0;throw new Error(a.error||"Erreur lors de la suppression de l'espace")}catch(a){return console.error("Error deleting space:",a),l(a instanceof Error?a:new Error("Erreur inconnue")),S.error("Erreur lors de la suppression de l'espace"),!1}finally{r(!1)}},[e]);return i.useEffect(()=>{_()},[e,I,_]),{space:m,spaces:u,loading:v,error:E,createSpace:g,updateSpace:p,deleteSpace:d,refetch:_}}function Pe(e){const[m,y]=i.useState([]),[u,n]=i.useState(!1),[v,r]=i.useState(null);return i.useEffect(()=>{if(console.log("ğŸ” useTimeSlotsAPI useEffect:",{spaceId:e}),!e){console.log("âš ï¸ Aucun spaceId, gÃ©nÃ©ration de crÃ©neaux par dÃ©faut");const l=[{id:"1",label:"09:00 - 10:00",startTime:"09:00",endTime:"10:00",price:0,isAvailable:!0,value:"1"},{id:"2",label:"10:00 - 11:00",startTime:"10:00",endTime:"11:00",price:0,isAvailable:!0,value:"2"},{id:"3",label:"11:00 - 12:00",startTime:"11:00",endTime:"12:00",price:0,isAvailable:!0,value:"3"},{id:"4",label:"14:00 - 15:00",startTime:"14:00",endTime:"15:00",price:0,isAvailable:!0,value:"4"},{id:"5",label:"15:00 - 16:00",startTime:"15:00",endTime:"16:00",price:0,isAvailable:!0,value:"5"},{id:"6",label:"16:00 - 17:00",startTime:"16:00",endTime:"17:00",price:0,isAvailable:!0,value:"6"}];console.log("ğŸ” CrÃ©neaux par dÃ©faut gÃ©nÃ©rÃ©s:",l),y(l);return}(async()=>{try{n(!0),r(null);const l=[{id:"1",label:"09:00 - 10:00",startTime:"09:00",endTime:"10:00",price:0,isAvailable:!0,value:"1"},{id:"2",label:"10:00 - 11:00",startTime:"10:00",endTime:"11:00",price:0,isAvailable:!0,value:"2"},{id:"3",label:"11:00 - 12:00",startTime:"11:00",endTime:"12:00",price:0,isAvailable:!0,value:"3"},{id:"4",label:"14:00 - 15:00",startTime:"14:00",endTime:"15:00",price:0,isAvailable:!0,value:"4"},{id:"5",label:"15:00 - 16:00",startTime:"15:00",endTime:"16:00",price:0,isAvailable:!0,value:"5"},{id:"6",label:"16:00 - 17:00",startTime:"16:00",endTime:"17:00",price:0,isAvailable:!0,value:"6"}];console.log("ğŸ” CrÃ©neaux gÃ©nÃ©rÃ©s:",l),y(l)}catch(l){console.error("Erreur chargement crÃ©neaux:",l),r("Erreur lors du chargement des crÃ©neaux")}finally{n(!1)}})()},[e]),{timeSlots:m,loading:u,error:v}}const Ve=Ae({space_id:re().min(1,"Espace requis"),start_time:re().min(1,"DÃ©but requis"),end_time:re().min(1,"Fin requise"),status:ke(["pending","confirmed","cancelled"]).optional(),total_price_ht:he().min(0).optional(),total_price_ttc:he().min(0).optional(),timeSlot:re().optional()});function Me(e){const{space:m,spaces:y,loading:u}=He(e),[n,v]=i.useState(null),[r,E]=i.useState(""),l=i.useCallback(T=>{v(T),E(T.id)},[]),I=i.useCallback(T=>{v(T),E(T.id)},[]),[_,g]=i.useState(!1),p=De({resolver:je(Ve),defaultValues:{space_id:(m==null?void 0:m.id)||"",start_time:"",end_time:"",status:"pending",total_price_ht:0,total_price_ttc:0,timeSlot:""}}),[d,s]=i.useState(new Date),[a,c]=i.useState({from:new Date,to:void 0}),[f,R]=i.useState(["monday","tuesday","wednesday","thursday","friday"]),[O,o]=i.useState(!1),[b,D]=i.useState(!1),[C,q]=i.useState(!1),ie=_e(),{createPaymentSession:j}=Te(),{timeSlots:w}=Pe(r),[L,U]=i.useState("");console.log("ğŸ” useBookingForm:",{spaceType:r,selectedSpaceId:n==null?void 0:n.id,timeSlotsLength:w.length,timeSlots:w}),i.useEffect(()=>{m&&(s(void 0),c({from:new Date,to:void 0}),U(""),o(!1),R(["monday","tuesday","wednesday","thursday","friday"]),q(!1))},[m]);const H=async T=>{try{const h=await F.post("/bookings",T);if(!h.success)throw new Error(h.error||"Erreur lors de la crÃ©ation de la rÃ©servation");return h.data}catch(h){throw console.error("Erreur crÃ©ation rÃ©servation:",h),h}},W=async(T,h)=>{try{const A={status:h,updated_at:new Date().toISOString()},x=await F.put(`/bookings/${T}`,{status:h});if(!x.success)throw new Error(x.error||"Erreur lors de la mise Ã  jour du statut")}catch(A){throw console.error("Erreur mise Ã  jour statut:",A),A}},$=async(T,h,A)=>{try{const x=await F.get(`/spaces/${T}`);if(!x.success||!x.data)throw new Error("Espace non trouvÃ©");const k=x.data,N=await F.get(`/bookings?space_id=${T}`);if(!N.success)throw new Error("Erreur lors de la rÃ©cupÃ©ration des rÃ©servations");const J=N.data||[];return{isAvailable:((J==null?void 0:J.filter(M=>isValidBooking(M)&&M.start_time<A&&M.end_time>h))||[]).length===0,space:k}}catch(x){throw console.error("Erreur vÃ©rification disponibilitÃ©:",x),x}},P=async T=>{g(!0);try{const h={...T,status:T.status||"pending"},A=await F.post("/bookings",h);if(!A.success)throw new Error(A.error||"Erreur lors de la sauvegarde");S.success("RÃ©servation sauvegardÃ©e")}catch(h){S.error("Erreur lors de la sauvegarde de la rÃ©servation"),console.error(h)}finally{g(!1)}},ne=(T,h)=>T.find(A=>A.value===h);return{form:p,loadingForm:_,isSubmitting:b,termsAccepted:C,setTermsAccepted:q,date:d,setDate:s,dateRange:a,setDateRange:c,selectedDays:f,setSelectedDays:R,isRecurring:O,setIsRecurring:o,timeSlots:w,timeSlot:L,setTimeSlot:U,selectedSpace:n,setSelectedSpace:v,handleSpaceSelect:l,handleSpaceChange:I,handleSubmit:async T=>{if(T.preventDefault(),!n||!L){S.error("Veuillez sÃ©lectionner un espace et un crÃ©neau horaire");return}if(!C){S.error("Veuillez accepter les conditions gÃ©nÃ©rales");return}D(!0);try{let h;if(L.startsWith("custom-")){const k=parseInt(L.split("-")[1]);h={id:`custom-${k}`,value:L,label:`${k} heure${k>1?"s":""}`,duration:k,price:0,start_time:"00:00",end_time:"23:59",is_available:!0,space_id:"",display_order:0}}else h=ne(w,L);if(!h)throw new Error("CrÃ©neau horaire invalide");const A={id:"current_user"},x=m;if(!x)throw new Error("Espace non trouvÃ© ou invalide");if(O&&(a!=null&&a.from)&&(a!=null&&a.to)){const k=[],N=new Date(a.from),J=new Date(a.to),V={sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6};for(;N<=J;){const B=N.getDay(),G=Object.keys(V).find(z=>V[z]===B);if(G&&f.includes(G)){const{startTime:z,endTime:me}=Z(new Date(N),h.label);if(!(await $(x.id,z.toISOString(),me.toISOString())).isAvailable){N.setDate(N.getDate()+1);continue}k.push({user_id:A.id,space_id:x.id,start_time:z.toISOString(),end_time:me.toISOString(),total_price_ht:te(x,h.duration).ht,total_price_ttc:te(x,h.duration).ttc,status:"confirmed"})}N.setDate(N.getDate()+1)}if(k.length===0)throw new Error("Aucun crÃ©neau disponible pour la pÃ©riode sÃ©lectionnÃ©e");const M=k.map(B=>({user_id:B.user_id,space_id:B.space_id,start_time:B.start_time,end_time:B.end_time,total_price_ht:B.total_price_ht,total_price_ttc:B.total_price_ttc,status:"pending"})),Y=await Promise.all(M.map(H));S.success(`${Y.length} rÃ©servations crÃ©Ã©es avec succÃ¨s !`)}else{const{startTime:k,endTime:N}=Z(d,h.label);if(!(await $(x.id,k.toISOString(),N.toISOString())).isAvailable){S.error("Cet espace n'est pas disponible pour la pÃ©riode sÃ©lectionnÃ©e"),D(!1);return}const V=te(x,h.duration),M={user_id:A.id,space_id:x.id,start_time:k.toISOString(),end_time:N.toISOString(),total_price_ht:V.ht,total_price_ttc:V.ttc,status:"pending"},Y=await H(M),B=A.email||"client@example.com";try{const{url:G,mode:z}=await j(Y.id,Math.round(V.ttc*100),B,{booking_id:Y.id,space_name:x.name||"Espace",start_time:k.toISOString(),end_time:N.toISOString()});S.info("Redirection vers la page de paiement..."),window.location.href=G;return}catch(G){console.error("Erreur lors de la crÃ©ation de la session de paiement:",G),S.error("Impossible de crÃ©er la session de paiement. Veuillez rÃ©essayer.");try{await W(Y.id,"cancelled")}catch(z){console.warn("Erreur lors de l'annulation de la rÃ©servation:",z)}D(!1);return}}setTimeout(()=>{ie("/dashboard")},1500)}catch(h){console.error("Error creating booking:",h),S.error(h instanceof Error?h.message:"Erreur lors de la rÃ©servation")}finally{D(!1)}},onSubmit:P,getSelectedTimeSlot:ne,spaceType:r,setSpaceType:E,spaces:y,loading:u,getSpacePrice:te,getPricingLabel:Ce}}const et=()=>{const{id:e}=we(),m=_e(),[y,u]=i.useState(!0),[n,v]=i.useState(null),{date:r,setDate:E,spaceType:l,setSpaceType:I,timeSlot:_,setTimeSlot:g,spaces:p,timeSlots:d,getSpacePrice:s,getPricingLabel:a,isSubmitting:c,loading:f,termsAccepted:R,setTermsAccepted:O}=Me();i.useEffect(()=>{(async()=>{try{if(!e)return;const w=await F.get(`/bookings/${e}`);if(!w.success){S.error("RÃ©servation non trouvÃ©e"),m("/dashboard");return}v(w.data),console.log("ğŸ” DonnÃ©es de rÃ©servation:",{space_id:w.data.space_id,start_date:w.data.start_date,end_date:w.data.end_date}),I(w.data.space_id),E(new Date(w.data.start_date))}catch(w){console.error("Error fetching booking:",w),S.error("Erreur lors du chargement de la rÃ©servation"),m("/dashboard")}finally{u(!1)}})()},[e,m,E,I,g]),i.useEffect(()=>{if(console.log("ğŸ” useEffect timeSlots:",{booking:!!n,timeSlotsLength:d.length,timeSlots:d}),d.length>0&&!n&&!_){console.log("ğŸ” SÃ©lection automatique du premier crÃ©neau"),g(d[0].id);return}if(!n||d.length===0)return;console.log("ğŸ” Recherche du crÃ©neau correspondant:",{start_date:n.start_date,end_date:n.end_date,timeSlotsAvailable:d.length});const j=new Date(n.start_date),w=new Date(n.end_date),L=new Date(j.getTime()+j.getTimezoneOffset()*6e4),U=new Date(w.getTime()+w.getTimezoneOffset()*6e4),H=L.getHours(),W=U.getHours();console.log("ğŸ” Heures locales:",{startHour:H,endHour:W});const $=d.find(P=>parseInt(P.startTime.split(":")[0])===H);console.log("ğŸ” CrÃ©neau trouvÃ©:",$),$?g($.id):(console.log("âš ï¸ Aucun crÃ©neau correspondant trouvÃ©, sÃ©lection du premier crÃ©neau"),d.length>0&&g(d[0].id))},[n,d,g]);const o=async()=>{console.log("ğŸ” handleSubmit appelÃ©:",{booking:!!n,spaceType:l,date:r,timeSlot:_});try{if(!n||!l||!r||!_){console.log("âŒ DonnÃ©es manquantes pour la soumission"),S.error("Veuillez remplir tous les champs");return}const j=p.find(P=>P.id===l);if(!j){console.log("âŒ Espace non trouvÃ©"),S.error("Espace non trouvÃ©");return}const w=d.find(P=>P.id===_);if(!w){console.log("âŒ CrÃ©neau horaire non trouvÃ©"),S.error("CrÃ©neau horaire non trouvÃ©");return}const{startTime:L,endTime:U}=Z(r,w.label),H=s(j),W={space_id:j.id,start_date:L.toISOString(),end_date:U.toISOString(),total_price:H.ht,status:"pending"};console.log("ğŸ“ DonnÃ©es de mise Ã  jour:",W);const $=await F.put(`/bookings/${n.id}`,W);if(console.log("ğŸ“ RÃ©ponse API:",$),!$.success)throw console.log("âŒ Erreur dans la rÃ©ponse API:",$),new Error($.error||"Erreur lors de la mise Ã  jour");console.log("âœ… RÃ©servation modifiÃ©e avec succÃ¨s, redirection vers /dashboard"),S.success("RÃ©servation modifiÃ©e avec succÃ¨s"),console.log("ğŸš€ Tentative de redirection vers /dashboard..."),m("/dashboard"),console.log("ğŸš€ Redirection exÃ©cutÃ©e")}catch(j){console.error("âŒ Error updating booking:",j),S.error("Erreur lors de la modification de la rÃ©servation")}};if(y)return t.jsxs("div",{className:"container mx-auto px-4 py-8",children:[t.jsx("div",{className:"mb-6",children:t.jsxs(ee,{variant:"outline",size:"sm",onClick:()=>m("/dashboard"),className:"flex items-center gap-2",children:[t.jsx(ge,{className:"h-4 w-4"}),"Retour au tableau de bord"]})}),t.jsx(le,{children:t.jsx(ce,{children:t.jsx(de,{children:"Chargement..."})})})]});const b=p.find(j=>j.id===l),D=s(b),C=d.find(j=>j.id===_);console.log("ğŸ” Ã‰tat du bouton:",{isSubmitting:c,spaceType:!!l,date:!!r,timeSlot:!!_,disabled:c||!l||!r||!_});const q=b?{...b,price:D.ttc,description:b.description??"",image_url:b.image_url??"",is_available:b.is_active??!0}:void 0,ie=C&&r?{id:C.id,label:C.label,startTime:Z(r,C.label).startTime.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),endTime:Z(r,C.label).endTime.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),price:D.ttc,isAvailable:C.is_available??!0}:void 0;return t.jsxs("div",{className:"container mx-auto px-4 py-8",children:[t.jsx("div",{className:"mb-6",children:t.jsxs(ee,{variant:"outline",size:"sm",onClick:()=>m("/dashboard"),className:"flex items-center gap-2",children:[t.jsx(ge,{className:"h-4 w-4"}),"Retour au tableau de bord"]})}),t.jsxs(le,{children:[t.jsx(ce,{children:t.jsx(de,{children:"Modifier la rÃ©servation"})}),t.jsx(ye,{children:t.jsxs("form",{onSubmit:o,className:"grid gap-6",children:[t.jsx(Be,{spaces:p,selected:l,onSelect:I,loading:f,getSpacePrice:s,getPricingLabel:a}),l&&t.jsx(Le,{selected:r,onSelect:E,timeSlots:d,selectedSlot:_,onSlotSelect:g}),q&&t.jsx(xe,{space:q,selectedDays:[r||new Date],selectedTimeSlot:ie,isRecurring:!1,dateRange:r?{from:r,to:r}:void 0,termsAccepted:R,onTermsChange:O,onSubmit:o}),t.jsxs("div",{className:"flex justify-end gap-4",children:[t.jsx(ee,{type:"button",variant:"outline",onClick:()=>m("/dashboard"),children:"Annuler"}),t.jsx(ee,{type:"button",disabled:c||!l||!r||!_,onClick:()=>{console.log("ğŸ” CLIC SUR LE BOUTON DÃ‰TECTÃ‰ !"),console.log("ğŸ” Ã‰tat des variables:",{isSubmitting:c,spaceType:l,date:r,timeSlot:_,disabled:c||!l||!r||!_}),console.log("ğŸ” Appel direct de handleSubmit..."),o()},children:"Modifier la rÃ©servation"})]})]})})]})]})};export{et as default};
