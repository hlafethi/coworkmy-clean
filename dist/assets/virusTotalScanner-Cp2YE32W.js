var p=Object.defineProperty;var f=(u,e,t)=>e in u?p(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var h=(u,e,t)=>f(u,typeof e!="symbol"?e+"":e,t);class d{constructor(){h(this,"apiKey");h(this,"baseUrl","https://www.virustotal.com/api/v3");h(this,"maxFileSize",32*1024*1024);this.apiKey="",this.apiKey||console.warn("⚠️ Clé API VirusTotal non configurée. Utilisation du scanner basique.")}async scanFile(e){try{if(e.size>this.maxFileSize)return{isClean:!1,threat:`Fichier trop volumineux pour l'analyse (max ${this.maxFileSize/1024/1024}MB)`};if(!this.apiKey)return await this.basicScan(e);const t=await this.calculateSHA256(e),a=await this.getFileReport(t);if(a)return this.parseVirusTotalResponse(a);const r=await this.uploadFile(e);if(!r)return{isClean:!1,threat:"Erreur lors de l'upload vers VirusTotal"};const s=await this.waitForScanResult(r);return s?this.parseVirusTotalResponse(s):{isClean:!1,threat:"Timeout lors de l'analyse antivirus"}}catch(t){return console.error("Erreur lors du scan VirusTotal:",t),await this.basicScan(e)}}async uploadFile(e){var t;try{const a=new FormData;a.append("file",e);const r=await fetch(`${this.baseUrl}/files`,{method:"POST",headers:{"X-Apikey":this.apiKey},body:a});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return((t=(await r.json()).data)==null?void 0:t.id)||null}catch(a){return console.error("Erreur upload VirusTotal:",a),null}}async getFileReport(e){try{const t=await fetch(`${this.baseUrl}/files/${e}`,{headers:{"X-Apikey":this.apiKey}});if(t.status===404)return null;if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(t){return console.error("Erreur récupération rapport:",t),null}}async waitForScanResult(e,t=10){var a,r,s,l;for(let o=0;o<t;o++)try{const i=await fetch(`${this.baseUrl}/analyses/${e}`,{headers:{"X-Apikey":this.apiKey}});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const c=await i.json();if(((r=(a=c.data)==null?void 0:a.attributes)==null?void 0:r.status)==="completed"){const n=(l=(s=c.data.meta)==null?void 0:s.file_info)==null?void 0:l.sha256;if(n)return await this.getFileReport(n)}await new Promise(n=>setTimeout(n,2e3))}catch(i){console.error(`Tentative ${o+1} échouée:`,i)}return null}parseVirusTotalResponse(e){const t=e.data.attributes.stats,a=e.data.attributes.results,r=t.malicious||0,s=t.suspicious||0,l=Object.keys(a).length,o=Object.entries(a).filter(([c,n])=>n.category==="malicious"||n.category==="suspicious").map(([c,n])=>`${c}: ${n.result}`),i=r===0&&s===0;return{isClean:i,threat:i?void 0:`Menaces détectées par ${r+s} moteur(s)`,details:{malicious:r,suspicious:s,total:l,engines:o},scanId:e.data.id}}async basicScan(e){try{const t=await e.arrayBuffer(),a=new Uint8Array(t),r=[[77,90,144,0],[127,69,76,70],[80,75,3,4,20,0,6,0]];for(const s of r)if(this.containsSignature(a,s))return{isClean:!1,threat:"Fichier exécutable ou archive suspecte détecté"};try{const s=await e.text(),l=["eval(","exec(","system(","shell_exec","passthru","<script","javascript:","vbscript:","onload=","onerror=","cmd.exe","powershell","/bin/sh","wget","curl","base64_decode","gzinflate","str_rot13"],o=s.toLowerCase();for(const i of l)if(o.includes(i))return{isClean:!1,threat:`Code potentiellement malveillant détecté: ${i}`}}catch{}return{isClean:!0}}catch(t){return console.error("Erreur scan basique:",t),{isClean:!1,threat:"Erreur lors de l'analyse de sécurité"}}}async calculateSHA256(e){const t=await e.arrayBuffer(),a=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map(s=>s.toString(16).padStart(2,"0")).join("")}containsSignature(e,t){if(e.length<t.length)return!1;for(let a=0;a<=e.length-t.length;a++){let r=!0;for(let s=0;s<t.length;s++)if(e[a+s]!==t[s]){r=!1;break}if(r)return!0}return!1}isApiAvailable(){return!!this.apiKey}async getApiUsage(){var e,t,a,r,s,l,o,i;if(!this.apiKey)return null;try{const c=await fetch(`${this.baseUrl}/users/${this.apiKey.substring(0,8)}`,{headers:{"X-Apikey":this.apiKey}});if(!c.ok)return null;const n=await c.json();return{used:((r=(a=(t=(e=n.data)==null?void 0:e.attributes)==null?void 0:t.quotas)==null?void 0:a.api_requests_monthly)==null?void 0:r.used)||0,limit:((i=(o=(l=(s=n.data)==null?void 0:s.attributes)==null?void 0:l.quotas)==null?void 0:o.api_requests_monthly)==null?void 0:i.allowed)||500}}catch{return null}}}const w=new d;export{w as virusTotalScanner};
