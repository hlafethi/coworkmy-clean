import{r as s,a as b,an as c,k as m,j as S}from"./index-DCtXYFOS.js";import"./client-7MFx3KKO.js";const k=()=>{const[l,i]=s.useState(null),[w,u]=s.useState(!0),[g,f]=s.useState(!1),[v,o]=s.useState(!1),I=b(),y=s.useRef(!1),t=s.useRef(!0),d=s.useRef(0);s.useEffect(()=>{t.current=!0;const n=async()=>{if(!y.current){y.current=!0;try{const{data:{user:e},error:r}=await c.auth.getUser();if(r){r.message.includes("Auth session missing")||(r.message.includes("Invalid JWT")||r.message.includes("JWT expired")?(localStorage.removeItem("sb-auth-token"),localStorage.removeItem("coworkmy-auth-token"),await c.auth.signOut()):console.error("[useAuth] Error getting initial user:",r)),t.current&&(i(null),f(!1),o(!0),u(!1));return}e&&t.current?(i(e),await p(e)):t.current&&(i(null),f(!1),o(!0)),t.current&&u(!1)}catch(e){console.error("[useAuth] Error during initialization:",e),t.current&&(i(null),f(!1),o(!0),u(!1))}}},{data:{subscription:a}}=c.auth.onAuthStateChange(async(e,r)=>{t.current&&(e==="SIGNED_IN"&&(r!=null&&r.user)?(i(r.user),o(!1),d.current=0,await p(r.user)):e==="SIGNED_OUT"?(i(null),f(!1),o(!0),d.current=0,localStorage.removeItem("sb-auth-token"),localStorage.removeItem("coworkmy-auth-token")):e==="USER_UPDATED"&&(r!=null&&r.user)&&(i(r.user),o(!1),await p(r.user)),t.current&&u(!1))});return n(),()=>{t.current=!1,a.unsubscribe()}},[]);const p=async n=>{try{let{data:a,error:e}=await c.from("profiles").select("is_admin, id, user_id, email").eq("user_id",n.id).single();if(e&&e.code==="PGRST116"){const{data:x,error:h}=await c.from("profiles").select("is_admin, id, user_id, email").eq("id",n.id).single();h?e=h:(a=x,e=null)}if(e&&e.code==="PGRST116"){const{data:x,error:h}=await c.from("profiles").select("is_admin, id, user_id, email").eq("email",n.email).single();h?e=h:(a=x,e=null)}if(e&&e.code!=="PGRST116")throw e;const r=(a==null?void 0:a.is_admin)||!1;r&&!n.email_confirmed_at&&m.warning("Votre email n'est pas confirmé. Certaines fonctionnalités admin peuvent être limitées."),t.current&&(f(r),o(!0),d.current=0)}catch(a){if(console.error("[useAuth] Error fetching profile:",a),a&&typeof a=="object"&&"message"in a){const e=a.message;if(e.includes("JWT expired")||e.includes("Invalid JWT")){m.error("Session expirée, veuillez vous reconnecter"),await E();return}}if(d.current<3){d.current++,console.log(`[useAuth] Retry ${d.current}/3 - Profile fetch failed`),setTimeout(()=>{t.current&&l&&p(l)},1e3*d.current);return}t.current&&(f(!1),o(!0))}},E=async()=>{try{const{error:n}=await c.auth.signOut();if(n)throw n;t.current&&(i(null),f(!1),o(!0)),localStorage.removeItem("sb-auth-token"),localStorage.removeItem("coworkmy-auth-token"),I("/auth/login")}catch(n){console.error("Erreur lors de la déconnexion:",n),m.error("Erreur lors de la déconnexion")}};return{user:l,loading:w||!v,isAdmin:g,signOut:E}};function T(){const l=b(),{checkSession:i}=k();return s.useEffect(()=>{(async()=>{try{const{data:{session:u},error:g}=await c.auth.getSession();if(g)throw g;u?(await i(),m.success("Connexion réussie"),l("/dashboard")):(m.error("Session non trouvée"),l("/auth/login"))}catch(u){console.error("Erreur lors de la connexion:",u),m.error("Erreur lors de la connexion"),l("/auth/login")}})()},[l,i]),S.jsx("div",{className:"flex items-center justify-center min-h-screen",children:S.jsxs("div",{className:"text-center",children:[S.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Connexion en cours..."}),S.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"})]})})}export{T as default};
