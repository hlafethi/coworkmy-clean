import{k as _,j as e,B as N,C as T,a as C,e as A,b as D,f as U,r as f,g as E,X as F,u as p,l as z}from"./index-t_7sXq-_.js";import{U as K,B as O}from"./users-ghhflmLj.js";import{L as G}from"./log-out-kOGU7Fuj.js";import{C as X}from"./calendar-XllxnvpJ.js";import{C as J,f as R}from"./dateUtils-DGuxbYwV.js";import{S as Q}from"./skeleton-BDwtniV7.js";import{f as $}from"./bookingUtils-yZhmP6yH.js";import{P as W}from"./pen-square-AbhyDQMo.js";import{S as Z}from"./StripeCustomerPortal-BLIAEogi.js";import"./stripeUtils-D6xlIHGD.js";import"./external-link-C1h2kOLr.js";import"./alert-circle-R20-9kvB.js";const ee=({firstName:r,lastName:a,onLogout:u})=>{const o=_();return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Mon Espace Personnel"}),e.jsxs("p",{className:"text-muted-foreground",children:["Bienvenue ",r," ",a]})]}),e.jsxs("div",{className:"space-x-4",children:[e.jsxs(N,{onClick:()=>o("/profile"),variant:"outline",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Mon profil"]}),e.jsxs(N,{onClick:u,variant:"outline",children:[e.jsx(G,{className:"mr-2 h-4 w-4"}),"Déconnexion"]})]})]})},se=({totalBookings:r,upcomingBookings:a})=>{const u=_();return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(T,{children:[e.jsxs(C,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(A,{className:"text-sm font-medium",children:"Mes réservations"}),e.jsx(X,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(D,{children:[e.jsx("div",{className:"text-2xl font-bold",children:r}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"réservations au total"})]})]}),e.jsxs(T,{children:[e.jsxs(C,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(A,{className:"text-sm font-medium",children:"Réservations à venir"}),e.jsx(J,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(D,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a===1?"réservation prochaine":"réservations prochaines"})]})]}),e.jsxs(T,{className:"relative overflow-hidden",children:[e.jsxs(C,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(A,{className:"text-sm font-medium",children:"Réserver un espace"}),e.jsx(O,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(D,{children:e.jsx(N,{className:"w-full",onClick:()=>u("/spaces"),children:"Nouvelle réservation"})})]})]})},re=()=>{const r=_();return e.jsxs(T,{children:[e.jsxs(C,{children:[e.jsx(A,{children:"Espaces disponibles"}),e.jsx(U,{children:"Consultez nos différents espaces de coworking"})]}),e.jsx(D,{children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"mb-4",children:"Découvrez nos espaces et leurs disponibilités"}),e.jsx(N,{onClick:()=>r("/spaces"),className:"w-full md:w-auto",children:"Voir les espaces"})]})})]})};let t={bookings:[],loading:!0,error:null,channel:null,userId:null,subscribers:new Set};const S=()=>{t.subscribers.forEach(r=>r(t.bookings,t.loading,t.error))};function te(){const[r,a]=f.useState(t.bookings),[u,o]=f.useState(t.loading),[c,x]=f.useState(t.error),j=f.useCallback(async()=>{try{t.loading=!0,t.error=null,S();const d=await E.getCurrentUser();if(!d.success||!d.data){t.bookings=[],t.loading=!1,S();return}const g=d.data;t.userId!==g.id&&(t.userId=g.id);const h=await E.get("/bookings");if(!h.success)throw new Error(h.error||"Erreur lors du chargement des réservations");const y=Array.isArray(h.data)?h.data:[];y.length===0?t.bookings=[]:t.bookings=y,t.loading=!1,S()}catch(d){console.error("❌ Erreur lors du chargement des réservations utilisateur:",d),t.error="Erreur lors du chargement des réservations",t.loading=!1,S()}},[]);return f.useEffect(()=>{const d=(g,h,y)=>{a(g),o(h),x(y)};return t.subscribers.add(d),t.bookings.length===0&&t.loading?j():(a(t.bookings),o(t.loading),x(t.error)),()=>{t.subscribers.delete(d)}},[j]),{bookings:r,loading:u,error:c,refetch:j}}const ae=({children:r,className:a=""})=>e.jsx("h2",{className:`text-2xl ${a}`,children:r});function ne({onBookingChange:r}){const{bookings:a,loading:u,error:o,refetch:c}=te(),x=_(),j=s=>{switch(s.toLowerCase()){case"confirmed":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"cancelled":return"bg-red-100 text-red-800";case"completed":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},d=s=>{switch(s.toLowerCase()){case"confirmed":return"Confirmée";case"pending":return"En attente";case"cancelled":return"Annulée";case"completed":return"Terminée";default:return s}},g=s=>{x(`/booking/edit/${s}`)},h=async s=>{try{(await E.put(`/bookings/${s}/status`,{status:"cancelled"})).success?(p.success("Réservation annulée avec succès"),c(),r==null||r()):p.error("Impossible d'annuler la réservation")}catch(i){console.error("Erreur lors de l'annulation:",i),p.error("Une erreur est survenue lors de l'annulation")}},y=async s=>{try{const i=await E.delete(`/bookings/${s}`);if(!i.success)throw console.error("Erreur lors de la suppression:",i.error),new Error(i.error||"Erreur lors de la suppression");p.success("Réservation supprimée avec succès"),c(),r==null||r()}catch(i){console.error("❌ Erreur lors de la suppression:",i),p.error("Impossible de supprimer la réservation")}},k=s=>s.toLowerCase()!=="cancelled"&&s.toLowerCase()!=="completed",M=s=>{switch(s){case"hourly":return"Tarification horaire";case"daily":return"Tarification journalière";case"monthly":return"Tarification mensuelle";case"yearly":return"Tarification annuelle";case"half_day":return"Demi-journée";case"quarter":return"Trimestrielle";case"custom":return"Tarification personnalisée";default:return"Tarification horaire"}},L=(s,i,w)=>{const m=new Date(s),v=new Date(i),n=v.getTime()-m.getTime(),l=Math.ceil(n/(1e3*60*60*24)),B=Math.ceil(n/(1e3*60*60));switch(w){case"hourly":return B<24?`${B} heure(s)`:`${l} jour(s)`;case"daily":return`${l} jour(s)`;case"monthly":const P=m.getFullYear(),H=m.getMonth(),q=v.getFullYear(),V=v.getMonth();return`${(q-P)*12+(V-H)} mois`;case"quarter":const Y=Math.floor(l/30);return`${Math.ceil(Y/3)} trimestre(s)`;case"yearly":return`${Math.floor(l/365)} an(s)`;default:return l===1?"1 jour":l<30?`${l} jours`:l<365?`${Math.ceil(l/30)} mois`:`${Math.ceil(l/365)} an(s)`}},b=(Array.isArray(a)?a:[]).sort((s,i)=>{const w=new Date(s.end_time),m=new Date(i.end_time),v=new Date,n=w>v,l=m>v;return n&&!l?-1:!n&&l?1:new Date(i.created_at).getTime()-new Date(s.created_at).getTime()});return u?e.jsx(Q,{className:"h-40 w-full"}):o?e.jsx("div",{className:"text-red-500",children:o}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:b.map(s=>{const m=new Date(s.end_date)<new Date;return e.jsxs(T,{className:`flex flex-col h-full ${m?"opacity-75":""}`,children:[e.jsx(C,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(ae,{children:s.space_name}),e.jsxs(U,{children:[R(s.start_time||s.start_date),s.end_time&&e.jsxs("span",{className:"text-gray-500 ml-2",children:["au ",R(s.end_time)]}),m&&e.jsx("span",{className:"text-gray-500 ml-2",children:"(Terminée)"})]})]}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${j(s.status)}`,children:d(s.status)})]})}),e.jsxs(D,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm text-gray-600",children:[e.jsx("span",{children:"Type:"}),e.jsx("span",{className:"font-medium",children:M(s.pricing_type)})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-gray-600",children:[e.jsx("span",{children:"Durée:"}),e.jsx("span",{className:"font-medium",children:L(s.start_time||s.start_date,s.end_time||s.end_date,s.pricing_type)})]})]}),e.jsxs("div",{className:"border-t pt-3 mb-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Prix HT:"}),e.jsx("span",{className:"text-sm",children:$(parseFloat(s.total_price_ht||s.total_price||0))})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"TVA (20%):"}),e.jsx("span",{className:"text-sm",children:$(parseFloat(s.total_price_ht||s.total_price||0)*.2)})]}),e.jsxs("div",{className:"flex justify-between items-center font-medium",children:[e.jsx("span",{children:"Total TTC:"}),e.jsx("span",{children:$(parseFloat(s.total_price_ttc||s.total_price||0))})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[k(s.status)&&!m&&e.jsxs(e.Fragment,{children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>g(s.id),children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"Modifier"]}),e.jsxs(N,{variant:"destructive",size:"sm",onClick:()=>h(s.id),children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Annuler"]})]}),e.jsxs(N,{variant:"destructive",size:"sm",onClick:()=>{window.confirm("Êtes-vous sûr de vouloir supprimer cette réservation ?")&&y(s.id)},children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Supprimer"]})]})]})]},s.id)})})}function ie(){const r=_(),{user:a,profile:u,isAdmin:o,loading:c,profileLoaded:x,signOut:j}=z(),[d,g]=f.useState(!0),[h,y]=f.useState({totalBookings:0,upcomingBookings:0,recentActivities:[]}),[k,M]=f.useState(0);return f.useEffect(()=>{(async()=>{if(typeof a>"u"||c)return;if(!a){p.error("Veuillez vous connecter pour accéder à cette page"),r("/auth/login");return}if(o){r("/admin");return}if(!x)return;const s=await E.get("/bookings");if(!s.success){p.error("Erreur lors du chargement des réservations"),g(!1);return}const i=s.data,w=Array.isArray(i)?i:[],m=new Date,v=w.filter(n=>new Date(n.end_date)>m);y({totalBookings:w.length,upcomingBookings:v.length,recentActivities:v.slice(0,5).map(n=>({id:n.id,description:`${n.space_name||"Espace"} - ${n.start_date}`,date:n.start_date,status:n.status,total_price_ht:n.total_price||0,total_price_ttc:n.total_price||0,startTime:n.start_date,endTime:n.end_date,spaceName:n.space_name||"Espace",pricingType:"hourly"}))||[]}),g(!1)})()},[r,a,o,c,x,k]),{loading:d||c||!x,isAdmin:o,stats:h,userProfile:u,handleLogout:async()=>{try{await j(),p.success("Déconnexion réussie")}catch(b){console.error("Erreur lors de la déconnexion:",b),p.error("Une erreur s'est produite lors de la déconnexion")}},refreshStats:()=>{M(b=>b+1)}}}const Ne=()=>{const r=_(),{user:a}=z(),{loading:u,stats:o,userProfile:c,handleLogout:x,refreshStats:j}=ie();return f.useEffect(()=>{a||(p.error("Vous devez être connecté pour accéder à cette page"),r("/auth/login"))},[a,r]),u?e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 bg-gray-200 rounded mb-6"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded mb-6"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(ee,{firstName:(c==null?void 0:c.first_name)||"Utilisateur",lastName:(c==null?void 0:c.last_name)||"",onLogout:x}),e.jsxs("div",{className:"container mx-auto px-4 pt-4 flex justify-end gap-2",children:[e.jsx(Z,{variant:"compact"}),e.jsx(N,{variant:"outline",onClick:()=>r("/support"),children:"🛟 Support"})]}),e.jsxs("main",{className:"container mx-auto px-4 py-8",children:[e.jsx(se,{totalBookings:o.totalBookings,upcomingBookings:o.upcomingBookings}),e.jsxs("div",{className:"mt-8",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Mes réservations"}),e.jsx("p",{className:"text-gray-600",children:"Gérez toutes vos réservations d'espaces de coworking"})]}),e.jsx(ne,{onBookingChange:j})]}),e.jsx("div",{className:"mt-8",children:e.jsx(re,{})})]})]})};export{Ne as default};
