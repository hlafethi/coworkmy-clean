var p=Object.defineProperty;var f=(u,e,t)=>e in u?p(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var h=(u,e,t)=>f(u,typeof e!="symbol"?e+"":e,t);class y{constructor(){h(this,"apiKey");h(this,"baseUrl","https://www.virustotal.com/api/v3");h(this,"maxFileSize",32*1024*1024);this.apiKey="",this.apiKey}async scanFile(e){try{if(e.size>this.maxFileSize)return{isClean:!1,threat:`Fichier trop volumineux pour l'analyse (max ${this.maxFileSize/1024/1024}MB)`};if(!this.apiKey)return await this.basicScan(e);const t=await this.calculateSHA256(e),s=await this.getFileReport(t);if(s)return this.parseVirusTotalResponse(s);const r=await this.uploadFile(e);if(!r)return{isClean:!1,threat:"Erreur lors de l'upload vers VirusTotal"};const a=await this.waitForScanResult(r);return a?this.parseVirusTotalResponse(a):{isClean:!1,threat:"Timeout lors de l'analyse antivirus"}}catch(t){return console.error("Erreur lors du scan VirusTotal:",t),await this.basicScan(e)}}async uploadFile(e){var t;try{const s=new FormData;s.append("file",e);const r=await fetch(`${this.baseUrl}/files`,{method:"POST",headers:{"X-Apikey":this.apiKey},body:s});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return((t=(await r.json()).data)==null?void 0:t.id)||null}catch(s){return console.error("Erreur upload VirusTotal:",s),null}}async getFileReport(e){try{const t=await fetch(`${this.baseUrl}/files/${e}`,{headers:{"X-Apikey":this.apiKey}});if(t.status===404)return null;if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(t){return console.error("Erreur récupération rapport:",t),null}}async waitForScanResult(e,t=10){var s,r,a,c;for(let o=0;o<t;o++)try{const n=await fetch(`${this.baseUrl}/analyses/${e}`,{headers:{"X-Apikey":this.apiKey}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const l=await n.json();if(((r=(s=l.data)==null?void 0:s.attributes)==null?void 0:r.status)==="completed"){const i=(c=(a=l.data.meta)==null?void 0:a.file_info)==null?void 0:c.sha256;if(i)return await this.getFileReport(i)}await new Promise(i=>setTimeout(i,2e3))}catch(n){console.error(`Tentative ${o+1} échouée:`,n)}return null}parseVirusTotalResponse(e){const t=e.data.attributes.stats,s=e.data.attributes.results,r=t.malicious||0,a=t.suspicious||0,c=Object.keys(s).length,o=Object.entries(s).filter(([l,i])=>i.category==="malicious"||i.category==="suspicious").map(([l,i])=>`${l}: ${i.result}`),n=r===0&&a===0;return{isClean:n,threat:n?void 0:`Menaces détectées par ${r+a} moteur(s)`,details:{malicious:r,suspicious:a,total:c,engines:o},scanId:e.data.id}}async basicScan(e){try{const t=await e.arrayBuffer(),s=new Uint8Array(t),r=[[77,90,144,0],[127,69,76,70],[80,75,3,4,20,0,6,0]];for(const o of r)if(this.containsSignature(s,o))return{isClean:!1,threat:"Fichier exécutable ou archive suspecte détecté"};const a=e.type;if(a.startsWith("text/")||a==="application/javascript"||a==="application/x-php"||a==="application/x-python"||a==="application/x-sh")try{const o=await e.text(),n=["eval(","exec(","system(","shell_exec","passthru","<script","javascript:","vbscript:","onload=","onerror=","base64_decode","gzinflate","str_rot13"],l=o.toLowerCase();for(const i of n)if(l.includes(i))return{isClean:!1,threat:`Code potentiellement malveillant détecté: ${i}`}}catch{}return{isClean:!0}}catch(t){return console.error("Erreur scan basique:",t),{isClean:!1,threat:"Erreur lors de l'analyse de sécurité"}}}async calculateSHA256(e){const t=await e.arrayBuffer(),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(a=>a.toString(16).padStart(2,"0")).join("")}containsSignature(e,t){if(e.length<t.length)return!1;for(let s=0;s<=e.length-t.length;s++){let r=!0;for(let a=0;a<t.length;a++)if(e[s+a]!==t[a]){r=!1;break}if(r)return!0}return!1}isApiAvailable(){return!!this.apiKey}async getApiUsage(){var e,t,s,r,a,c,o,n;if(!this.apiKey)return null;try{const l=await fetch(`${this.baseUrl}/users/${this.apiKey.substring(0,8)}`,{headers:{"X-Apikey":this.apiKey}});if(!l.ok)return null;const i=await l.json();return{used:((r=(s=(t=(e=i.data)==null?void 0:e.attributes)==null?void 0:t.quotas)==null?void 0:s.api_requests_monthly)==null?void 0:r.used)||0,limit:((n=(o=(c=(a=i.data)==null?void 0:a.attributes)==null?void 0:c.quotas)==null?void 0:o.api_requests_monthly)==null?void 0:n.allowed)||500}}catch{return null}}}const w=new y;export{w as virusTotalScanner};
